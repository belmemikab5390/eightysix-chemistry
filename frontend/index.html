<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chunks - AI Interactive Chemistry Learning</title>
<!-- 3Dmol.js Library -->
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<!-- PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- MathJax for Math & Chemistry Equations -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      packages: {'[+]': ['mhchem']}
    },
    loader: {load: ['[tex]/mhchem']},
    startup: {
      pageReady: () => {
        return MathJax.startup.defaultPageReady();
      }
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  /* ==========================================
     RESET & BASE STYLES
     ========================================== */
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    height: 100vh; 
    background: #0a0a0f; 
    overflow: hidden;
    display: flex;
    flex-direction: column;
    color: white;
  }

  /* ==========================================
     WELCOME SCREEN
     ========================================== */

  .welcome-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    transition: opacity 0.3s ease;
    background: linear-gradient(135deg, #0f1218 0%, #0a0a0f 50%, #12151a 100%);
  }

  .welcome-screen.hidden {
    display: none;
  }

  /* Top Bar */
  .welcome-topbar {
    padding: 16px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .welcome-topbar-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .menu-btn {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.7);
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: 0.2s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .menu-btn:hover {
    background: rgba(255,255,255,0.08);
    color: white;
  }

  .welcome-logo {
    font-size: 20px; 
    font-weight: 700; 
    background: linear-gradient(135deg, #667eea, #764ba2); 
    -webkit-background-clip:text; 
    -webkit-text-fill-color:transparent; 
    background-clip: text;
  }

  @keyframes gradientShift { 
    0%,100%{background-position:0% 50%;}
    50%{background-position:100% 50%;} 
  }

  .welcome-topbar-right {
    display: flex;
    gap: 12px;
  }

  .topbar-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: rgba(255,255,255,0.7);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
  }

  .topbar-btn:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.2);
    color: white;
  }

  /* Welcome Content */
  .welcome-content {
    flex: 1;
    overflow-y: auto;
    padding: 32px 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .welcome-title {
    font-size: 42px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #667eea, #a855f7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .welcome-subtitle {
    font-size: 15px;
    color: rgba(255,255,255,0.5);
    text-align: center;
    margin-bottom: 50px;
    max-width: 600px;
    line-height: 1.5;
  }

  /* Feature Cards */
  .feature-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    width: 100%;
    max-width: 1200px;
    margin-bottom: 50px;
  }

  .feature-card {
    background: rgba(20, 20, 30, 0.4);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    padding: 40px 30px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
  }

  .feature-card:hover {
    background: rgba(25, 25, 35, 0.5);
    border-color: rgba(102,126,234,0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  .feature-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .feature-icon svg {
    width: 56px;
    height: 56px;
    filter: drop-shadow(0 6px 20px rgba(102, 126, 234, 0.3));
  }

  .feature-title {
    font-size: 20px;
    font-weight: 700;
    color: white;
    margin-bottom: 10px;
    letter-spacing: -0.3px;
  }

  .feature-description {
    font-size: 14px;
    color: rgba(255,255,255,0.5);
    line-height: 1.5;
  }

  /* Key Features Section */
  .key-features {
    width: 100%;
    max-width: 1000px;
    margin-bottom: 50px;
    background: rgba(20, 20, 30, 0.3);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 16px;
    padding: 40px;
  }

  .key-features-title {
    font-size: 28px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 35px;
    color: white;
  }

  .key-feature-list {
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  .key-feature-item {
    display: flex;
    gap: 18px;
    align-items: flex-start;
  }

  .key-feature-icon {
    width: 44px;
    height: 44px;
    background: rgba(102,126,234,0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .key-feature-content h3 {
    font-size: 18px;
    font-weight: 700;
    color: white;
    margin-bottom: 6px;
    letter-spacing: -0.3px;
  }

  .key-feature-content p {
    font-size: 14px;
    color: rgba(255,255,255,0.5);
    line-height: 1.5;
  }

  /* Action Buttons */
  .welcome-actions {
    display: flex;
    gap: 14px;
    margin-bottom: 35px;
  }

  .action-btn {
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .action-btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 16px rgba(102,126,234,0.3);
  }

  .action-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102,126,234,0.4);
  }

  .action-btn-secondary {
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.8);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .action-btn-secondary:hover {
    background: rgba(255,255,255,0.12);
  }

  /* ==========================================
     HEADER (for split-screen mode)
     ========================================== */
  .header { 
    display: none; /* Hidden until PDF loaded */
    justify-content: flex-start; 
    align-items: center; 
    padding: 12px 20px; 
    color: white; 
    background: #1a1a1a; 
    border-bottom: 1px solid #333; 
  }

  .header.active {
    display: flex;
  }
  
  .logo { 
    font-size: 32px; 
    font-weight: 800; 
    background: linear-gradient(45deg,#667eea,#764ba2,#f093fb,#667eea); 
    background-size: 300% 300%; 
    -webkit-background-clip:text; 
    -webkit-text-fill-color:transparent; 
    animation: gradientShift 3s ease infinite; 
  }
  
  .header-title { 
    font-size: 20px; 
    font-weight:600; 
    color:white; 
  }
  
  .header-status { 
    font-size: 14px; 
    opacity:0.9; 
  }

  .history-toggle-btn {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: 0.2s;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .history-toggle-btn:hover {
    background: rgba(255,255,255,0.08);
    color: white;
  }

  /* ==========================================
     MAIN LAYOUT - FLEXBOX
     ========================================== */
  .main-container { 
    display: none; /* Hidden until PDF loaded */
    flex: 1;
    min-height: 0;
  }

  .main-container.active {
    display: flex;
  }

  .pdf-panel { 
    flex: 1;
    min-width: 0;
    background: #2a2a2a; 
    display: flex; 
    flex-direction: column; 
    border-right: 2px solid #444; 
    position: relative;
  }

  .chat-panel { 
    flex: 1;
    min-width: 0;
    background: #1e1e1e; 
    display: flex; 
    flex-direction: column;
  }
  
/* ==========================================
   CHUNKS SIDEBAR - CLAUDE STYLE
   ========================================== */

/* Base Sidebar Container */
.chat-history-sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 280px;
  height: 100vh;
  background: #1a1a1a;
  border-right: 1px solid #333;
  z-index: 1000;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  box-shadow: 4px 0 12px rgba(0,0,0,0.3);
}

.chat-history-sidebar.open {
  transform: translateX(0);
}

/* Header */
.chunks-sidebar-header {
  height: 56px;
  border-bottom: 1px solid #333;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
}

.chunks-logo {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.chunks-close-btn {
  background: transparent;
  border: none;
  color: #888;
  padding: 4px;
  cursor: pointer;
  transition: color 0.2s;
  font-size: 24px;
  line-height: 1;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.chunks-close-btn:hover {
  background: #333;
  color: white;
}

/* New Chat Button */
.chunks-new-chat-container {
  padding: 12px;
}

.chunks-new-chat-btn {
  width: 100%;
  height: 40px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.chunks-new-chat-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Tab Navigation */
.chunks-tabs-nav {
  border-bottom: 1px solid #333;
  display: flex;
  height: 44px;
}

.chunks-tab-btn {
  flex: 1;
  background: transparent;
  border: none;
  color: #888;
  font-size: 11px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  cursor: pointer;
  transition: all 0.2s;
  padding: 0 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chunks-tab-btn:hover {
  color: white;
  background: #252525;
}

.chunks-tab-btn.active {
  background: #2a2a2a;
  color: #667eea;
}

/* Tab Content */
.chunks-tab-content {
  flex: 1;
  overflow: hidden;
  position: relative;
}

.chunks-tab-panel {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none;
  flex-direction: column;
}

.chunks-tab-panel.active {
  display: flex;
}

/* Search Bar */
.chunks-search-container {
  padding: 12px 12px 8px 12px;
  border-bottom: 1px solid #2a2a2a;
}

.chunks-search-wrapper {
  position: relative;
}

.chunks-search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #666;
  font-size: 14px;
}

.chunks-search-input {
  width: 100%;
  height: 36px;
  background: #252525;
  border: 1px solid #333;
  border-radius: 6px;
  padding-left: 36px;
  padding-right: 12px;
  color: white;
  font-size: 13px;
}

.chunks-search-input::placeholder {
  color: #666;
}

.chunks-search-input:focus {
  outline: none;
  border-color: #667eea;
  background: #2a2a2a;
}

/* Chat List */
.chunks-chat-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.chat-history-item {
  position: relative;
  padding: 12px;
  margin: 4px 0;
  background: #252525;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
}

.chat-history-item:hover {
  background: #2a2a2a;
  border-left-color: #667eea;
  transform: translateX(2px);
}

.chat-history-item.active {
  background: #2a2a2a;
  border-left-color: #667eea;
}

.chat-history-title {
  font-size: 13px;
  font-weight: 600;
  color: white;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.chat-history-preview {
  font-size: 11px;
  color: #888;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.chat-history-time {
  font-size: 10px;
  color: #666;
}

.chat-history-delete {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: #666;
  padding: 4px 8px;
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s;
  border-radius: 4px;
  font-size: 14px;
}

.chat-history-item:hover .chat-history-delete {
  opacity: 1;
}

.chat-history-delete:hover {
  background: #ff4444;
  color: white;
}

/* Section Headers */
.chunks-section-header {
  padding: 12px 16px;
  font-size: 11px;
  font-weight: 700;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid #2a2a2a;
}

/* Contents List */
.chunks-content-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.chunks-content-item {
  padding: 12px;
  margin: 4px 0;
  background: #252525;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
}

.chunks-content-item:hover {
  background: #2a2a2a;
  border-left-color: #667eea;
  transform: translateX(2px);
}

.chunks-content-title {
  font-size: 13px;
  font-weight: 600;
  color: white;
  margin-bottom: 4px;
}

.chunks-content-page {
  font-size: 11px;
  color: #888;
}

/* Books List */
.chunks-books-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.chunks-book-card {
  margin-bottom: 12px;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.chunks-book-card:hover {
  border-color: #444;
  transform: translateY(-2px);
}

.chunks-book-card.active {
  border-color: #667eea;
}

.chunks-book-cover {
  height: 80px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
}

.chunks-book-info {
  background: #252525;
  padding: 12px;
}

.chunks-book-title {
  font-size: 13px;
  font-weight: 600;
  color: white;
  margin-bottom: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.chunks-book-pages {
  font-size: 11px;
  color: #888;
}

/* Empty States */
.chat-history-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  padding: 40px 20px;
}

.chunks-empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.chunks-empty-text {
  font-size: 13px;
  color: #666;
  margin-bottom: 16px;
}

.chunks-upload-btn {
  padding: 8px 16px;
  background: rgba(102, 126, 234, 0.1);
  border: 2px solid rgba(102, 126, 234, 0.3);
  border-radius: 6px;
  color: #667eea;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.chunks-upload-btn:hover {
  background: rgba(102, 126, 234, 0.2);
  border-color: rgba(102, 126, 234, 0.5);
}

/* ==========================================
   LIBRARY MODAL STYLES
   ========================================== */

.library-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.library-modal.active {
  display: flex;
}

.library-modal-content {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  width: 90%;
  max-width: 1000px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.library-modal-header {
  padding: 24px 32px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.library-modal-title {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea, #a855f7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.library-modal-close {
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 24px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: all 0.2s;
}

.library-modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.library-modal-body {
  padding: 24px 32px;
  max-height: 60vh;
  overflow-y: auto;
}

.library-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

.library-book-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.library-book-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, #667eea, #a855f7);
  opacity: 0;
  transition: opacity 0.3s;
}

.library-book-card:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(102, 126, 234, 0.4);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
}

.library-book-card:hover::before {
  opacity: 1;
}

.library-book-icon {
  width: 120px;
  height: 160px;
  margin: 0 auto 16px;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s;
}

.library-book-card:hover .library-book-icon {
  transform: scale(1.05);
}

.library-book-title {
  font-size: 16px;
  font-weight: 700;
  color: white;
  margin-bottom: 8px;
  line-height: 1.3;
}

.library-book-author {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.6);
  margin-bottom: 8px;
}

.library-book-edition {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
  margin-bottom: 12px;
}

.library-book-meta {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.library-book-badge {
  font-size: 11px;
  padding: 4px 8px;
  background: rgba(102, 126, 234, 0.15);
  border: 1px solid rgba(102, 126, 234, 0.3);
  border-radius: 4px;
  color: #667eea;
}

/* Progress Tab Styles */
#progress-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0;
}

.progress-stat-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.progress-stat-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
}

.progress-stat-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}

.progress-stat-label {
  font-size: 11px;
  color: rgba(255,255,255,0.6);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.progress-topic-list {
  margin-top: 20px;
}

.progress-topic-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.progress-topic-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.progress-topic-name {
  font-size: 13px;
  font-weight: 600;
  color: white;
}

.progress-topic-accuracy {
  font-size: 12px;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 4px;
  background: rgba(102,126,234,0.15);
  color: #667eea;
}

.progress-topic-stats {
  display: flex;
  gap: 12px;
  font-size: 11px;
  color: rgba(255,255,255,0.6);
}

.progress-history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0 12px 0;
  padding: 0 4px;
}

.progress-history-title {
  font-size: 12px;
  font-weight: 600;
  color: rgba(255,255,255,0.8);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.progress-session-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 12px;
}

.progress-session-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
}

.progress-session-topic {
  font-weight: 600;
  color: white;
}

.progress-session-date {
  color: rgba(255,255,255,0.5);
  font-size: 10px;
}

.progress-session-stats {
  display: flex;
  gap: 12px;
  color: rgba(255,255,255,0.6);
}

.progress-empty {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255,255,255,0.5);
}

.progress-empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.3;
}

.progress-empty-text {
  font-size: 13px;
}

/* Scrollbar Styling */
.chunks-chat-list::-webkit-scrollbar,
.chunks-content-list::-webkit-scrollbar,
.chunks-books-list::-webkit-scrollbar {
  width: 6px;
}

.chunks-chat-list::-webkit-scrollbar-track,
.chunks-content-list::-webkit-scrollbar-track,
.chunks-books-list::-webkit-scrollbar-track {
  background: transparent;
}

.chunks-chat-list::-webkit-scrollbar-thumb,
.chunks-content-list::-webkit-scrollbar-thumb,
.chunks-books-list::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 3px;
}

.chunks-chat-list::-webkit-scrollbar-thumb:hover,
.chunks-content-list::-webkit-scrollbar-thumb:hover,
.chunks-books-list::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .chat-history-sidebar {
    width: 85%;
    max-width: 320px;
  }
}

/* ==========================================
   HEALTH REMINDER MODAL
   ========================================== */

.health-reminder-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { 
    transform: translateY(30px);
    opacity: 0;
  }
  to { 
    transform: translateY(0);
    opacity: 1;
  }
}

.health-reminder-modal {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  text-align: center;
  animation: slideUp 0.4s ease-out;
  position: relative;
}

.health-reminder-icon {
  font-size: 80px;
  margin-bottom: 20px;
  animation: bounce 1s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.health-reminder-title {
  font-size: 28px;
  font-weight: 700;
  color: white;
  margin-bottom: 16px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.health-reminder-message {
  font-size: 18px;
  color: rgba(255, 255, 255, 0.95);
  margin-bottom: 12px;
  line-height: 1.6;
}

.health-reminder-time {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 30px;
}

.health-reminder-tips {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
  backdrop-filter: blur(10px);
}

.health-reminder-tips-title {
  font-size: 14px;
  font-weight: 600;
  color: white;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.health-tip-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  font-size: 15px;
  color: rgba(255, 255, 255, 0.9);
  text-align: left;
}

.health-tip-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.health-reminder-button {
  background: white;
  color: #667eea;
  border: none;
  padding: 16px 40px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.health-reminder-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.health-reminder-button:active {
  transform: translateY(0);
}

@media (max-width: 600px) {
  .health-reminder-modal {
    padding: 30px 20px;
  }
  
  .health-reminder-icon {
    font-size: 60px;
  }
  
  .health-reminder-title {
    font-size: 24px;
  }
  
  .health-reminder-message {
    font-size: 16px;
  }
}
  
  /* (Rest of your existing CSS continues here - all the PDF sidebar, toolbar, viewer, chat, flashcards, molecules, etc.) */
  /* I'm including ALL your existing CSS below */
</style>

<!-- ALL YOUR EXISTING CSS CONTINUES (copying from your original file) -->
<style>
  /* ==========================================
     PDF SIDEBAR
     ========================================== */
  .pdf-sidebar {
    position: absolute;
    left: 0;
    top: 0;
    width: 280px;
    height: 100%;
    background: #1a1a1a;
    border-right: 2px solid #444;
    z-index: 100;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
  }
  
  .pdf-sidebar.open {
    transform: translateX(0);
  }
  
  .sidebar-header {
    padding: 12px 16px;
    background: #252525;
    border-bottom: 2px solid #444;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .sidebar-tabs {
    display: flex;
    gap: 8px;
  }
  
  .sidebar-tab {
    background: transparent;
    border: none;
    color: #888;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: 0.2s;
  }
  
  .sidebar-tab.active {
    background: #667eea;
    color: white;
  }
  
  .sidebar-tab:hover:not(.active) {
    background: #333;
    color: #aaa;
  }
  
  .sidebar-close {
    background: transparent;
    border: none;
    color: #aaa;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: 0.2s;
  }
  
  .sidebar-close:hover {
    background: #333;
    color: white;
  }
  
  .sidebar-search {
    padding: 12px 16px;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
  }
  
  .sidebar-search input {
    width: 100%;
    padding: 8px 12px;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 6px;
    color: white;
    font-size: 13px;
  }
  
  .sidebar-search input:focus {
    outline: none;
    border-color: #667eea;
  }
  
  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }
  
  .sidebar-panel {
    display: none;
  }
  
  .sidebar-panel.active {
    display: block;
  }
  
  .outline-item {
    padding: 8px 12px;
    margin: 2px 0;
    background: #252525;
    border-radius: 4px;
    cursor: pointer;
    transition: 0.2s;
    border-left: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .outline-item:hover {
    background: #2a2a2a;
    border-left-color: #667eea;
    transform: translateX(2px);
  }
  
  .outline-item.level-1 {
    padding-left: 12px;
    font-weight: 600;
  }
  
  .outline-item.level-2 {
    padding-left: 24px;
    font-size: 13px;
  }
  
  .outline-item.level-3 {
    padding-left: 36px;
    font-size: 12px;
    opacity: 0.9;
  }
  
  .outline-title {
    flex: 1;
    color: white;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .outline-page {
    color: #888;
    font-size: 11px;
    font-weight: 600;
  }
  
  .outline-empty, .thumbnails-empty {
    padding: 40px 20px;
    text-align: center;
    color: #666;
    font-size: 13px;
  }
  
  .outline-loading {
    padding: 40px 20px;
    text-align: center;
  }
  
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #444;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 12px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .thumbnails-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    padding: 4px;
  }
  
  .thumbnail-item {
    background: #252525;
    border-radius: 6px;
    padding: 8px;
    cursor: pointer;
    transition: 0.2s;
    border: 2px solid transparent;
  }
  
  .thumbnail-item:hover {
    border-color: #667eea;
    transform: scale(1.02);
  }
  
  .thumbnail-item.active {
    border-color: #667eea;
    background: #2a2a2a;
  }
  
  .thumbnail-canvas {
    width: 100%;
    height: auto;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  
  .thumbnail-label {
    text-align: center;
    color: #aaa;
    font-size: 11px;
    margin-top: 6px;
    font-weight: 600;
  }

  /* ==========================================
     PDF TOOLBAR
     ========================================== */
  .pdf-toolbar {
    background: #323639;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #1a1a1a;
    height: 48px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .toolbar-section {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .toolbar-center {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }

  .toolbar-btn {
    background: transparent;
    border: none;
    color: #e8eaed;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 32px;
  }

  .toolbar-btn:hover {
    background: rgba(232, 234, 237, 0.1);
  }

  .toolbar-btn:active {
    background: rgba(232, 234, 237, 0.2);
  }

  .toolbar-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .toolbar-divider {
    width: 1px;
    height: 24px;
    background: #5f6368;
    margin: 0 4px;
  }

  .zoom-level {
    color: #e8eaed;
    font-size: 13px;
    min-width: 45px;
    text-align: center;
    font-weight: 500;
  }

  .page-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(232, 234, 237, 0.1);
    padding: 4px 12px;
    border-radius: 4px;
  }

  .page-input {
    background: transparent;
    border: none;
    color: #e8eaed;
    width: 45px;
    text-align: center;
    font-size: 13px;
    font-weight: 500;
    padding: 4px;
  }

  .page-input:focus {
    outline: none;
    background: rgba(232, 234, 237, 0.1);
    border-radius: 2px;
  }

  .page-separator {
    color: #9aa0a6;
    font-size: 13px;
  }

  .page-total {
    color: #9aa0a6;
    font-size: 13px;
    font-weight: 500;
    min-width: 30px;
  }

  .search-overlay {
    position: absolute;
    top: 48px;
    right: 16px;
    background: #323639;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    padding: 12px;
    z-index: 1000;
    display: none;
  }

  .search-overlay.active {
    display: block;
  }

  .search-input {
    background: rgba(232, 234, 237, 0.1);
    border: 1px solid #5f6368;
    border-radius: 4px;
    padding: 8px 12px;
    color: #e8eaed;
    font-size: 14px;
    width: 250px;
  }

  .search-input:focus {
    outline: none;
    border-color: #8ab4f8;
  }

  .search-results {
    color: #9aa0a6;
    font-size: 12px;
    margin-top: 8px;
    text-align: center;
  }

  /* ==========================================
     PDF VIEWER
     ========================================== */
  .pdf-viewer { 
    flex:1; 
    overflow-y:auto; 
    padding:20px; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    position:relative; 
  }
  
  #pdf-canvas { 
    box-shadow:0 4px 20px rgba(0,0,0,0.5); 
    max-width:100%; 
    height:auto; 
    display:none; 
  }
  
  .pdf-placeholder { 
    color:#666; 
    text-align:center; 
    padding:60px 20px; 
  }
  
  .upload-btn { 
    background:#667eea; 
    color:white; 
    padding:12px 24px; 
    border:none; 
    border-radius:8px; 
    cursor:pointer; 
    font-size:16px; 
    font-weight:600; 
    margin-top:20px; 
    transition:0.2s; 
  }
  
  .upload-btn:hover { 
    background:#5568d3; 
    transform:translateY(-2px); 
  }

  /* ==========================================
     CHAT PANEL
     ========================================== */
  .chat-messages { 
    flex: 1; 
    overflow-y: auto; 
    padding: 24px;
  }
  
  .message { 
    margin-bottom:20px; 
    animation: slideIn 0.3s ease-out; 
  }
  
  @keyframes slideIn { 
    from {opacity:0; transform:translateY(10px);} 
    to {opacity:1; transform:translateY(0);} 
  }
  
  .message.user { 
    display:flex; 
    justify-content:flex-end; 
  }
  
  .message-bubble { 
    padding:16px 20px; 
    border-radius:18px; 
    max-width:80%; 
    box-shadow:0 4px 12px rgba(0,0,0,0.15); 
  }
  
  .message.user .message-bubble { 
    background:#667eea; 
    color:white; 
  }
  
  .message.ai .message-bubble { 
    background:#2a2a2a; 
    color:#e0e0e0; 
    border:1px solid #444;
    line-height: 1.8;
    font-size: 15px;
  }
  
  .page-reference { 
    display:inline-flex; 
    align-items:center; 
    gap:8px; 
    background:rgba(102,126,234,0.2); 
    color:#a8b9ff; 
    padding:8px 16px; 
    border-radius:20px; 
    font-size:13px; 
    font-weight:600; 
    margin:8px 0; 
    cursor:pointer; 
    border:1px solid rgba(102,126,234,0.3); 
    transition:0.3s; 
  }
  
  .page-reference:hover { 
    background:rgba(102,126,234,0.3); 
    transform:translateX(4px); 
  }
  
  .source-footer { 
    margin-top:12px; 
    padding-top:12px; 
    border-top:1px solid #444; 
    font-size:12px; 
    color:#888; 
  }
/* ==========================================
   COMPACT CONTROLS BAR
   ========================================== */
.compact-controls-bar {
  padding: 12px 24px;
  background: #2a2a2a;
  border-top: 1px solid #444;
  border-bottom: 1px solid #444;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
}

.mode-compact {
  display: flex;
  align-items: center;
  gap: 10px;
}

.mode-compact label {
  color: #888;
  font-size: 13px;
  font-weight: 600;
}

.mode-dropdown {
  padding: 8px 12px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  color: #e0e0e0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
  outline: none;
}

.mode-dropdown:hover {
  background: #222;
  border-color: #444;
}

.mode-dropdown:focus {
  outline: none;
  border-color: #667eea;
  background: #222;
}

/* Style dropdown options */
.mode-dropdown option {
  background: #1a1a1a;
  color: white;
  padding: 10px;
  font-weight: 600;
}

.mode-dropdown option:hover {
  background: #667eea !important;
  color: white !important;
}

.mode-dropdown option:checked {
  background: #667eea;
  color: white;
}

.complexity-compact {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  max-width: 400px;
}

.complexity-compact label {
  color: #888;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

#complexity-value-compact {
  color: #667eea;
  font-weight: 700;
  min-width: 15px;
  text-align: center;
}

.complexity-slider-compact {
  flex: 1;
  -webkit-appearance: none;
  height: 6px;
  border-radius: 3px;
  background: linear-gradient(to right, 
    #666 0%, 
    #999 50%, 
    #ccc 100%
  );
  outline: none;
  cursor: pointer;
}

.complexity-slider-compact::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: white;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  border: 2px solid #888;
  transition: 0.2s;
}

.complexity-slider-compact::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  border-color: #fff;
}

.complexity-slider-compact::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: white;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  border: 2px solid #888;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .compact-controls-bar {
    flex-direction: column;
    gap: 12px;
    padding: 12px 16px;
  }
  
  .mode-compact {
    width: 100%;
  }
  
  .mode-dropdown {
    flex: 1;
  }
  
  .complexity-compact {
    width: 100%;
    max-width: 100%;
  }
}
  
  /* ==========================================
     CHAT INPUT
     ========================================== */
  .chat-input-container { 
    padding: 20px 24px; 
    background: #2a2a2a; 
    border-top: 1px solid #444;
  }
  
  .chat-input-wrapper { 
    display:flex; 
    gap:12px; 
  }
  
  .chat-input { 
    flex:1; 
    padding:14px 18px; 
    background:#1e1e1e; 
    border:2px solid #444; 
    border-radius:10px; 
    color:white; 
    font-size:15px; 
  }
  
  .chat-input:focus { 
    outline:none; 
    border-color:#667eea; 
  }
  
  .send-btn { 
    padding:14px 28px; 
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
    color:white; 
    border:none; 
    border-radius:12px; 
    font-weight:700; 
    cursor:pointer; 
    transition:0.3s; 
    box-shadow:0 4px 15px rgba(102,126,234,0.4); 
  }
  
  .send-btn:hover { 
    transform:translateY(-2px); 
    box-shadow:0 8px 20px rgba(102,126,234,0.4); 
  }
  
  .send-btn:disabled { 
    opacity:0.5; 
    cursor:not-allowed; 
  }
  
  .clear-chat-btn {
    background: rgba(255,77,87,0.15);
    color: #ff4757;
    border: 1px solid rgba(255,77,87,0.3);
    padding: 10px 16px;
    border-radius: 8px;
    margin-right: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .clear-chat-btn:hover {
    background: rgba(255,77,87,0.25);
    border-color: rgba(255,77,87,0.5);
    transform: translateY(-1px);
  }
  
  .clear-chat-btn:active {
    transform: translateY(0);
  }
  
  .typing-indicator { 
    display:none; 
    padding:14px 18px; 
    background:#2a2a2a; 
    border:1px solid #444; 
    border-radius:12px; 
    max-width:80px; 
  }
  
  .typing-indicator.active { 
    display:block; 
  }
  
  .typing-dots { 
    display:flex; 
    gap:6px; 
  }
  
  .typing-dots span { 
    width:10px; 
    height:10px; 
    background:linear-gradient(135deg,#667eea,#764ba2); 
    border-radius:50%; 
    animation: bounce 1.4s infinite; 
  }
  
  .typing-dots span:nth-child(2) { 
    animation-delay:0.2s; 
  }
  
  .typing-dots span:nth-child(3) { 
    animation-delay:0.4s; 
  }
  
  @keyframes bounce { 
    0%,60%,100%{transform:translateY(0);}
    30%{transform:translateY(-10px);} 
  }

  /* ==========================================
     FLASHCARDS
     ========================================== */
  .flashcard-bubble { 
    max-width: 95% !important; 
  }

  /* Flashcard Controls */
  .flashcard-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 16px 0;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    gap: 12px;
    flex-wrap: wrap;
  }

  .flashcard-progress {
    flex: 1;
    min-width: 200px;
  }

  .progress-text {
    font-size: 13px;
    color: rgba(255,255,255,0.7);
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
  }

  .progress-bar {
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.3s ease;
    border-radius: 4px;
  }

  .flashcard-stats {
    display: flex;
    gap: 16px;
    font-size: 13px;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .stat-correct { color: #4ade80; }
  .stat-incorrect { color: #f87171; }
  .stat-streak { color: #fbbf24; }
  
  .mini-flashcards { 
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px; 
    margin-top: 16px; 
  }
  
  /* Single card display - bigger, centered */
  .mini-card { 
    perspective: 1000px; 
    cursor: pointer; 
    width: 100%;
    max-width: 500px;
    height: 200px;
    position: relative;
  }
  
  .mini-card-inner { 
    position: relative; 
    width: 100%; 
    height: 100%; 
    transition: transform 0.3s ease;
    transform-style: preserve-3d; 
  }
  
  .mini-card.flipped .mini-card-inner { 
    transform: rotateY(180deg); 
  }
  
  .mini-card-front, .mini-card-back { 
    position: absolute; 
    width: 100%; 
    height: 100%; 
    backface-visibility: hidden; 
    border-radius: 12px; 
    padding: 24px; 
    display: flex; 
    flex-direction: column; 
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    border: 2px solid rgba(255,255,255,0.1);
  }
  
  .mini-card-front { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .mini-card-back { 
    background: #1a1a1a;
    color: #e0e0e0; 
    transform: rotateY(180deg); 
    border: 2px solid #333;
  }

  .card-label {
    font-size: 12px;
    font-weight: 600;
    opacity: 0.7;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .card-content {
    font-size: 18px;
    line-height: 1.6;
    text-align: center;
    font-weight: 500;
  }

  /* Action buttons */
  .flashcard-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .flashcard-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-flip {
    background: rgba(255,255,255,0.1);
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
  }

  .btn-flip:hover {
    background: rgba(255,255,255,0.15);
  }

  .btn-know {
    background: #4ade80;
    color: white;
  }

  .btn-know:hover {
    background: #22c55e;
  }

  .btn-dont-know {
    background: #f87171;
    color: white;
  }

  .btn-dont-know:hover {
    background: #ef4444;
  }

  .btn-skip {
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .btn-skip:hover {
    background: rgba(255,255,255,0.1);
  }

  .flashcard-complete {
    text-align: center;
    padding: 32px;
    background: rgba(102,126,234,0.1);
    border-radius: 12px;
    border: 1px solid rgba(102,126,234,0.3);
  }

  .complete-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 16px;
    color: #667eea;
  }

  .complete-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
    margin: 24px 0;
  }

  .complete-stat {
    padding: 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
  }

  .complete-stat-value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .complete-stat-label {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .mini-card {
      height: 180px;
    }

    .card-content {
      font-size: 16px;
    }

    .flashcard-actions {
      width: 100%;
    }

    .flashcard-btn {
      flex: 1;
      min-width: 120px;
    }

    .flashcard-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .flashcard-stats {
      justify-content: space-between;
      width: 100%;
    }
  }

  /* ==========================================
     MATHJAX / LATEX FORMATTING
     ========================================== */
  .message-bubble h3 {
    color: #a8b9ff;
    font-size: 16px;
    margin: 16px 0 8px 0;
    font-weight: 600;
  }

  .message-bubble ul {
    margin: 8px 0;
    padding-left: 20px;
  }

  .message-bubble li {
    margin: 6px 0;
    line-height: 1.6;
  }

  .message-bubble code {
    background: rgba(102,126,234,0.15);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #e8eaed;
    font-size: 14px;
  }

  .message-bubble .MJXc-display {
    margin: 16px 0 !important;
    padding: 12px;
    background: rgba(102,126,234,0.1);
    border-radius: 8px;
    border-left: 3px solid #667eea;
  }

  .message-bubble .MathJax {
    color: #a8b9ff !important;
    font-weight: 500;
  }

  .message-bubble p:has(strong) {
    margin: 12px 0;
    padding: 8px 12px;
    background: rgba(102,126,234,0.08);
    border-radius: 6px;
    border-left: 2px solid #667eea;
  }

  .message-bubble blockquote {
    margin: 12px 0;
    padding: 12px 16px;
    background: rgba(102,126,234,0.1);
    border-left: 4px solid #667eea;
    border-radius: 4px;
  }

  .message-bubble table {
    border-collapse: collapse;
    margin: 12px 0;
    width: 100%;
  }

  .message-bubble th,
  .message-bubble td {
    border: 1px solid #444;
    padding: 8px 12px;
    text-align: left;
  }

  .message-bubble th {
    background: rgba(102,126,234,0.2);
    font-weight: 600;
  }

  .message-bubble .mjx-chem {
    color: #f093fb !important;
    font-weight: 500;
  }

  .message-bubble > p {
    margin: 8px 0;
  }

  .message-bubble > p:first-child {
    margin-top: 0;
  }

  /* ==========================================
     SCROLLBAR
     ========================================== */
  ::-webkit-scrollbar { 
    width: 8px; 
    height: 8px; 
  }
  
  ::-webkit-scrollbar-track { 
    background: transparent; 
  }
  
  ::-webkit-scrollbar-thumb { 
    background: #444; 
    border-radius: 4px; 
  }
  
  ::-webkit-scrollbar-thumb:hover { 
    background: #555; 
  }

  /* ==========================================
     3D MOLECULE VIEWER
     ========================================== */
#molecule-bubbles-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
}

.molecule-bubble {
    position: fixed;
    width: 90px;
    height: 90px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: grab;
    pointer-events: auto;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    animation: float 4s ease-in-out infinite;
    user-select: none;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.molecule-bubble:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
}

.molecule-bubble.dragging {
    cursor: grabbing;
    animation: none;
    transform: scale(1.1);
    box-shadow: 0 20px 50px rgba(102, 126, 234, 0.8);
}

.molecule-bubble-icon {
    font-size: 32px;
    margin-bottom: 4px;
}

.molecule-bubble-name {
    font-size: 11px;
    color: white;
    font-weight: 600;
    text-align: center;
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-10px);
    }
}

.molecule-bubble:nth-child(1) {
    animation-delay: 0s;
}

.molecule-bubble:nth-child(2) {
    animation-delay: 1s;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.molecule-bubble:nth-child(3) {
    animation-delay: 2s;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.molecule-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

.molecule-modal.active {
    display: flex;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.molecule-modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 20px;
    width: 90%;
    max-width: 800px;
    height: 80vh;
    max-height: 700px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(102, 126, 234, 0.3);
    animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes slideUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.molecule-modal-header {
    padding: 20px 30px;
    background: rgba(102, 126, 234, 0.1);
    border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 20px 20px 0 0;
}

.molecule-modal-header h3 {
    margin: 0;
    color: #667eea;
    font-size: 24px;
    font-weight: 600;
}

.modal-close-btn {
    background: none;
    border: none;
    color: #667eea;
    font-size: 40px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    border-radius: 50%;
}

.modal-close-btn:hover {
    background: rgba(255, 71, 87, 0.2);
    color: #ff4757;
    transform: rotate(90deg);
}

.modal-viewer-3d {
    flex: 1;
    background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
    position: relative;
    min-height: 400px;
}

.molecule-modal-controls {
    padding: 20px;
    display: flex;
    gap: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-control-btn {
    flex: 1;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.modal-control-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
}

.modal-control-btn:active {
    transform: translateY(-1px);
}

.modal-control-btn span:first-child {
    font-size: 24px;
}

.molecule-modal-info {
    padding: 20px 30px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0 0 20px 20px;
}

.atom-legend {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #ccc;
}

.atom-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* ==========================================
   ENHANCED MOLECULE VIEWER STYLES
   ========================================== */

/* Enhanced Modal Content */
.molecule-modal-content-enhanced {
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(15, 15, 30, 0.98) 100%);
    border-radius: 24px;
    padding: 0;
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    height: auto; /* Allow height to adjust */
    overflow-y: auto; /* Enable scrolling */
    overflow-x: hidden;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: slideUpEnhanced 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    flex-direction: column;
}

/* Custom scrollbar for modal */
.molecule-modal-content-enhanced::-webkit-scrollbar {
    width: 8px;
}

.molecule-modal-content-enhanced::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 0 24px 24px 0;
}

.molecule-modal-content-enhanced::-webkit-scrollbar-thumb {
    background: rgba(102, 126, 234, 0.5);
    border-radius: 4px;
}

.molecule-modal-content-enhanced::-webkit-scrollbar-thumb:hover {
    background: rgba(102, 126, 234, 0.7);
}

/* Ensure header doesn't shrink */
.molecule-modal-header-enhanced {
    flex-shrink: 0;
}

/* Make viewer flexible but not too large */
.modal-viewer-3d-enhanced {
    height: 400px;
    min-height: 250px; /* Minimum height */
    max-height: 50vh; /* Don't take more than half viewport */
    width: 100%;
    background: #0f0f1e;
    position: relative;
    overflow: hidden;
    border-top: 1px solid rgba(102, 126, 234, 0.1);
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    flex-shrink: 0;
}

/* Ensure controls don't shrink */
.molecule-controls-enhanced {
    flex-shrink: 0;
}

/* Ensure properties panel is scrollable if needed */
.molecule-properties-panel {
    flex-shrink: 0;
}

/* Ensure legend doesn't shrink */
.atom-legend-enhanced {
    flex-shrink: 0;
}

@keyframes slideUpEnhanced {
    from {
        transform: translateY(100px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* Enhanced Header with Glassmorphism */
.molecule-modal-header-enhanced {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
    backdrop-filter: blur(10px);
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.molecule-header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.molecule-icon-pulse {
    font-size: 36px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.molecule-name-enhanced {
    font-size: 24px;
    font-weight: 700;
    color: white;
    margin: 0;
    text-shadow: 0 2px 10px rgba(102, 126, 234, 0.5);
}

.molecule-formula {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.6);
    margin: 4px 0 0 0;
    font-family: 'Courier New', monospace;
}

.modal-close-btn-enhanced {
    background: rgba(255, 77, 87, 0.15);
    border: 1px solid rgba(255, 77, 87, 0.3);
    border-radius: 12px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    color: #ff4d57;
}

.modal-close-btn-enhanced:hover {
    background: rgba(255, 77, 87, 0.25);
    transform: rotate(90deg);
}

/* Enhanced 3D Viewer */
.modal-viewer-3d-enhanced {
    height: 400px;
    width: 100%;
    background: #0f0f1e;
    position: relative;
    overflow: hidden;
    border-top: 1px solid rgba(102, 126, 234, 0.1);
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
}

/* Enhanced Controls */
.molecule-controls-enhanced {
    padding: 20px 24px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.control-section {
    margin-bottom: 20px;
}

.control-section:last-child {
    margin-bottom: 0;
}

.control-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Style Button Group */
.style-button-group {
    display: flex;
    gap: 8px;
}

.style-btn {
    flex: 1;
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.style-btn:hover {
    background: rgba(102, 126, 234, 0.2);
    border-color: rgba(102, 126, 234, 0.4);
    color: white;
    transform: translateY(-2px);
}

.style-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.style-btn svg {
    flex-shrink: 0;
}

/* Toggle Switches */
.toggle-group {
    display: flex;
    gap: 20px;
}

.toggle-switch {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.toggle-switch input[type="checkbox"] {
    display: none;
}

.toggle-slider {
    width: 44px;
    height: 24px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    position: relative;
    transition: all 0.3s;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: white;
    top: 2px;
    left: 2px;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch input:checked + .toggle-slider {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

.toggle-label {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

/* Action Buttons */
.action-button-group {
    display: flex;
    gap: 8px;
}

.action-btn {
    flex: 1;
    padding: 12px 16px;
    background: rgba(102, 126, 234, 0.15);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 10px;
    color: #667eea;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.action-btn:hover {
    background: rgba(102, 126, 234, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.action-btn svg {
    flex-shrink: 0;
}

/* Molecular Properties Panel */
.molecule-properties-panel {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    margin: 0 24px 20px 24px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.properties-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.properties-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.property-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.property-label {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.property-value {
    font-size: 15px;
    color: white;
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

/* Enhanced Atom Legend */
.atom-legend-enhanced {
    display: flex;
    gap: 16px;
    padding: 16px 24px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    flex-wrap: wrap;
    justify-content: center;
}

.legend-item-enhanced {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
}

.atom-dot-enhanced {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Spin animation for loading */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .molecule-modal-content-enhanced {
        width: 98%;
        max-height: 95vh;
    }
    
    .modal-viewer-3d-enhanced {
        height: 300px;
        min-height: 200px;
        max-height: 40vh; /* Smaller on mobile */
    }
    
    .style-button-group {
        flex-direction: column;
    }
    
    .properties-grid {
        grid-template-columns: 1fr;
    }
    
    .toggle-group {
        flex-direction: column;
        gap: 12px;
    }
    
    .action-button-group {
        flex-direction: column;
    }
    
    .atom-legend-enhanced {
        gap: 12px;
    }
    
    .molecule-modal-header-enhanced {
        padding: 16px;
    }
    
    .molecule-name-enhanced {
        font-size: 20px;
    }
    
    .molecule-icon-pulse {
        font-size: 28px;
    }
}

/* Extra small screens / minimized windows */
@media (max-height: 600px) {
    .molecule-modal-content-enhanced {
        max-height: 95vh;
    }
    
    .modal-viewer-3d-enhanced {
        height: 200px;
        min-height: 150px;
        max-height: 30vh; /* Even smaller on very short screens */
    }
    
    .molecule-controls-enhanced {
        padding: 12px 16px;
    }
    
    .control-section {
        margin-bottom: 12px;
    }
}

/* Small height windows - ensure scrolling works */
@media (max-height: 800px) {
    .modal-viewer-3d-enhanced {
        max-height: 40vh;
    }
}

  /* ==========================================
     RESPONSIVE DESIGN
     ========================================== */

  @media screen and (max-width: 1024px) {
    .main-container {
      flex-direction: column;
    }
    
    .pdf-panel {
      flex: 0 0 45vh;
      border-right: none;
      border-bottom: 2px solid #444;
    }
    
    .chat-panel {
      flex: 1;
      min-height: 0;
    }
    
    .pdf-sidebar {
      width: 250px;
    }

    .feature-cards {
      grid-template-columns: 1fr;
    }
  }

  @media screen and (max-width: 768px) {
    .header {
      padding: 10px 16px;
    }
    
    .logo, .welcome-logo {
      font-size: 24px;
    }
    
    .header-title {
      font-size: 14px;
    }
    
    .header-status {
      display: none;
    }
    
    .pdf-panel {
      flex: 0 0 40vh;
    }
    
    .pdf-sidebar {
      width: 100%;
    }
    
    .pdf-toolbar {
      padding: 6px 10px;
      flex-wrap: wrap;
      height: auto;
      gap: 8px;
    }
    
    .toolbar-btn {
      padding: 6px 10px;
      min-width: 36px;
      height: 32px;
    }
    
    .toolbar-center {
      position: static;
      transform: none;
      order: 3;
      width: 100%;
      justify-content: center;
    }

    .welcome-topbar {
      padding: 16px 20px;
    }

    .welcome-title {
      font-size: 32px;
    }

    .welcome-subtitle {
      font-size: 16px;
    }

    .welcome-actions {
      flex-direction: column;
      width: 100%;
    }

    .action-btn {
      width: 100%;
      justify-content: center;
    }

    .atom-legend {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  .material-btn {
  width: 100%;
  padding: 16px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  color: white;
  text-align: left;
  cursor: pointer;
  transition: 0.2s;
  font-size: 16px;
  font-weight: 600;
}

.material-btn:hover {
  background: rgba(102, 126, 234, 0.2);
  border-color: rgba(102, 126, 234, 0.3);
  transform: translateY(-2px);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<style>
  /* ICON SYSTEM */
  .icon {
    display: inline-block;
    vertical-align: middle;
    stroke: currentColor;
    fill: none;
    flex-shrink: 0;
  }
  
  button .icon, a .icon {
    margin-right: 6px;
  }
  
  .icon-only {
    padding: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .icon-only .icon {
    margin: 0 !important;
  }
</style>
</head>
<body>
<!-- SVG ICON DEFINITIONS - Reusable throughout the app -->
<svg style="display: none;">
  <defs>
    <!-- Menu/Hamburger Icon -->
    <symbol id="icon-menu" viewBox="0 0 24 24">
      <line x1="3" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Chat Bubble Icon -->
    <symbol id="icon-chat" viewBox="0 0 24 24">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Document/Contents Icon -->
    <symbol id="icon-document" viewBox="0 0 24 24">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="14 2 14 8 20 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="9" y1="13" x2="15" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="9" y1="17" x2="15" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Books/Library Icon -->
    <symbol id="icon-books" viewBox="0 0 24 24">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="10" y1="6" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="10" y1="10" x2="16" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Plus Icon -->
    <symbol id="icon-plus" viewBox="0 0 24 24">
      <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
    </symbol>
    
    <!-- Search Icon -->
    <symbol id="icon-search" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Trash/Delete Icon -->
    <symbol id="icon-trash" viewBox="0 0 24 24">
      <polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Close/X Icon -->
    <symbol id="icon-close" viewBox="0 0 24 24">
      <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Zoom In Icon -->
    <symbol id="icon-zoom-in" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="11" y1="8" x2="11" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="8" y1="11" x2="14" y2="11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Zoom Out Icon -->
    <symbol id="icon-zoom-out" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="8" y1="11" x2="14" y2="11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Download Icon -->
    <symbol id="icon-download" viewBox="0 0 24 24">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="7 10 12 15 17 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Print Icon -->
    <symbol id="icon-print" viewBox="0 0 24 24">
      <polyline points="6 9 6 2 18 2 18 9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="6" y="14" width="12" height="8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Upload/Folder Icon -->
    <symbol id="icon-upload" viewBox="0 0 24 24">
      <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Brain Icon (Study Mode) -->
    <symbol id="icon-brain" viewBox="0 0 24 24">
      <path d="M12 4.5C10.5 3 8.5 3 7 4.5c-1 1-1.5 2.5-1.5 4v4c0 2.5 1.5 4.5 3.5 5.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M12 4.5C13.5 3 15.5 3 17 4.5c1 1 1.5 2.5 1.5 4v4c0 2.5-1.5 4.5-3.5 5.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <circle cx="9" cy="10" r="1" fill="currentColor"/>
      <circle cx="15" cy="10" r="1" fill="currentColor"/>
    </symbol>
    
    <!-- Book Icon (Exam Mode) -->
    <symbol id="icon-book-open" viewBox="0 0 24 24">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Flask Icon (Practice Mode) -->
    <symbol id="icon-flask" viewBox="0 0 24 24">
      <path d="M9 3h6v7l4 8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2l4-8V3z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="12" y1="3" x2="12" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- File Text Icon (Summary Mode) -->
    <symbol id="icon-file-text" viewBox="0 0 24 24">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="14 2 14 8 20 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="10" y1="9" x2="8" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    
    <!-- Arrow Left Icon -->
    <symbol id="icon-arrow-left" viewBox="0 0 24 24">
      <line x1="19" y1="12" x2="5" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <polyline points="12 19 5 12 12 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Arrow Right Icon -->
    <symbol id="icon-arrow-right" viewBox="0 0 24 24">
      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <polyline points="12 5 19 12 12 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Send Icon -->
    <symbol id="icon-send" viewBox="0 0 24 24">
      <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <polygon points="22 2 15 22 11 13 2 9 22 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Eye Icon -->
    <symbol id="icon-eye" viewBox="0 0 24 24">
      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    
    <!-- Layers/Stack Icon (States) -->
    <symbol id="icon-layers" viewBox="0 0 24 24">
      <polygon points="12 2 2 7 12 12 22 7 12 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="2 17 12 22 22 17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <polyline points="2 12 12 17 22 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </defs>
</svg>



<!-- SIDEBAR -->
<div class="chat-history-sidebar" id="chat-history-sidebar">
  <!-- Header -->
  <div class="chunks-sidebar-header">
    <div class="chunks-logo">Chunks</div>
    <button class="chunks-close-btn" onclick="toggleChatHistory()"><svg class="icon" width="20" height="20"><use href="#icon-close"/></svg></button>
  </div>
  
  <!-- New Chat Button -->
  <div class="chunks-new-chat-container">
    <button class="chunks-new-chat-btn" onclick="createNewChat()">
      <span style="font-size:18px;"><svg class="icon" width="16" height="16"><use href="#icon-plus"/></svg></span>
      <span>New Chat</span>
    </button>
  </div>
  
  <!-- Tab Navigation -->
  <div class="chunks-tabs-nav">
    <button class="chunks-tab-btn active" data-tab="chats" onclick="switchChunksTab('chats')">
      <svg class="icon" width="18" height="18"><use href="#icon-chat"/></svg> Chats
    </button>
    <button class="chunks-tab-btn" data-tab="contents" onclick="switchChunksTab('contents')">
      <svg class="icon" width="18" height="18"><use href="#icon-document"/></svg> Contents
    </button>
    <button class="chunks-tab-btn" data-tab="books" onclick="switchChunksTab('books')">
      <svg class="icon" width="18" height="18"><use href="#icon-books"/></svg> Books
    </button>
    <button class="chunks-tab-btn" data-tab="progress" onclick="switchChunksTab('progress')">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
      </svg>
      Progress
    </button>
  </div>
  
  <div style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
  <h3 style="color: #aaa; font-size: 13px; margin-bottom: 12px; text-transform: uppercase;">
     Lecture Materials
  </h3>
  
  <button onclick="document.getElementById('ppt-upload').click()" style="
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  ">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" x2="12" y1="3" y2="15"/>
    </svg>
    Upload Lecture Slides
  </button>
  
  <input 
    type="file" 
    id="ppt-upload" 
    accept=".ppt,.pptx" 
    style="display: none;"
    onchange="handlePPTUpload(event)"
  >
</div>

  <!-- Tab Content -->
  <div class="chunks-tab-content">
    
    <!-- CHATS TAB -->
    <div class="chunks-tab-panel active" id="panel-chats">
      <div class="chunks-search-container">
        <div class="chunks-search-wrapper">
          <span class="chunks-search-icon"><svg class="icon" width="16" height="16"><use href="#icon-search"/></svg></span>
          <input 
            type="text" 
            class="chunks-search-input" 
            placeholder="Search chats..." 
            id="chunks-search-input"
            oninput="filterChatHistory()"
          >
        </div>
      </div>
      
      <div class="chunks-chat-list" id="chat-history-list">
        <!-- Chats will be inserted here -->
      </div>
    </div>
    
    <!-- CONTENTS TAB -->
    <div class="chunks-tab-panel" id="panel-contents">
      <div class="chunks-section-header">
         Table of Contents
      </div>
      <div class="chunks-content-list" id="chunks-content-list">
        <div class="chat-history-empty">
          <div class="chunks-empty-icon"><svg class="icon" width="18" height="18"><use href="#icon-document"/></svg></div>
          <div class="chunks-empty-text">Select a book to see contents</div>
        </div>
      </div>
    </div>
    
    <!-- BOOKS TAB -->
    <div class="chunks-tab-panel" id="panel-books">
      <div class="chunks-section-header">
        <svg class="icon" width="18" height="18"><use href="#icon-books"/></svg> My Textbooks
      </div>
      <div class="chunks-books-list" id="chunks-books-list">
        <div class="chat-history-empty">
          <div class="chunks-empty-icon"><svg class="icon" width="18" height="18"><use href="#icon-books"/></svg></div>
          <div class="chunks-empty-text">Select a book from the library</div>
          <button class="chunks-upload-btn" onclick="openLibraryModal()">
            Browse Library
          </button>
        </div>
      </div>
    </div>
    
    <!-- PROGRESS TAB -->
    <div class="chunks-tab-panel" id="panel-progress">
      <div class="chunks-section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
        Study Progress
      </div>
      <div id="progress-content">
        <!-- Progress content will be dynamically loaded -->
      </div>
    </div>
    
  </div>
</div>

<!-- WELCOME SCREEN -->
<div class="welcome-screen" id="welcome-screen">
  <div class="welcome-topbar">
    <div class="welcome-topbar-left">
      <button class="menu-btn" onclick="toggleChatHistory()"><svg class="icon" width="20" height="20"><use href="#icon-menu"/></svg></button>
      <div class="welcome-logo">Chunks</div>
    </div>
    <div class="welcome-topbar-right">
      <!-- Buttons removed for cleaner interface -->
    </div>
  </div>
  
  <div class="welcome-content">
    <h1 class="welcome-title">Welcome to Chunks</h1>
    <p class="welcome-subtitle">
      Your AI-powered chemistry learning companion. Browse our textbook library, ask questions, and master chemistry at your own learning level.
    </p>
    
    <!-- Feature Cards -->
    <div class="feature-cards">
      <div class="feature-card">
        <div class="feature-icon">
          <!-- Lucide Book Open Icon (Blue) -->
          <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 7v14"/>
            <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/>
          </svg>
        </div>
        <h3 class="feature-title">PDF Viewer</h3>
        <p class="feature-description">View and navigate your textbooks seamlessly</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">
          <!-- Lucide Brain Icon (Purple-Pink Gradient) -->
          <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="url(#brainGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <defs>
              <linearGradient id="brainGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#a855f7;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
              </linearGradient>
            </defs>
            <path d="M12 18V5"/>
            <path d="M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4"/>
            <path d="M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5"/>
            <path d="M17.997 5.125a4 4 0 0 1 2.526 5.77"/>
            <path d="M18 18a4 4 0 0 0 2-7.464"/>
            <path d="M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517"/>
            <path d="M6 18a4 4 0 0 1-2-7.464"/>
            <path d="M6.003 5.125a4 4 0 0 0-2.526 5.77"/>
          </svg>
        </div>
        <h3 class="feature-title">AI Chat</h3>
        <p class="feature-description">Ask questions and get instant explanations</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">
          <!-- Lucide Sparkles Icon (Blue-Purple Gradient) -->
          <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="url(#sparkleGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <defs>
              <linearGradient id="sparkleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
              </linearGradient>
            </defs>
            <path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"/>
            <path d="M20 2v4"/>
            <path d="M22 4h-4"/>
            <circle cx="4" cy="20" r="2"/>
          </svg>
        </div>
        <h3 class="feature-title">Study Tools</h3>
        <p class="feature-description">Flashcards, 3D molecules, and practice modes</p>
      </div>
    </div>
    
    <!-- Key Features -->
    <div class="key-features">
      <h2 class="key-features-title">Key Features</h2>
      <div class="key-feature-list">
        <div class="key-feature-item">
          <div class="key-feature-icon"><svg class="icon" width="18" height="18"><use href="#icon-chat"/></svg></div>
          <div class="key-feature-content">
            <h3>Smart Chat History</h3>
            <p>All your conversations organized and searchable with instant access</p>
          </div>
        </div>
        
        <div class="key-feature-item">
          <div class="key-feature-icon"></div>
          <div class="key-feature-content">
            <h3>Table of Contents</h3>
            <p>Navigate through chapters and sections with ease</p>
          </div>
        </div>
        
        <div class="key-feature-item">
          <div class="key-feature-icon"></div>
          <div class="key-feature-content">
            <h3>Quick Access</h3>
            <p>Switch between textbooks and topics effortlessly</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="welcome-actions">
      <button class="action-btn action-btn-primary" onclick="openLibraryModal()">
        <span></span>
        <span>Browse Library</span>
      </button>
      <button class="action-btn action-btn-secondary" onclick="alert('Demo feature - This would show a sample PDF!')">
        <span></span>
        <span>View Demo</span>
      </button>
    </div>
  </div>
</div>

<!-- LIBRARY MODAL -->
<div class="library-modal" id="library-modal">
  <div class="library-modal-content">
    <div class="library-modal-header">
      <h2 class="library-modal-title"> Textbook Library</h2>
      <button class="library-modal-close" onclick="closeLibraryModal()"></button>
    </div>
    <div class="library-modal-body">
      <div class="library-grid">
        <!-- Chemistry Textbook - Zumdahl (AVAILABLE NOW) -->
        <div class="library-book-card" onclick="selectBook('zumdahl')">
          <div class="library-book-icon" style="background-image: url('covers/zumdahl.jpg');"></div>
          <div class="library-book-title">General Chemistry</div>
          <div class="library-book-author">Zumdahl & Zumdahl</div>
          <div class="library-book-edition">9th Edition</div>
          <div class="library-book-meta">
            <span class="library-book-badge"> Available</span>
            <span class="library-book-badge">Chemistry</span>
          </div>
        </div>

        <!-- Coming Soon Books (Disabled) -->
       <div class="library-book-card" onclick="selectBook('atkins')">
          <div class="library-book-icon" style="background-image: url('covers/atkins.jpg');"></div>
          <div class="library-book-title">Physical Chemistry</div>
          <div class="library-book-author">Atkins & de Paula</div>
          <div class="library-book-edition">8th Edition</div>
          <div class="library-book-meta">
            <span class="library-book-badge"> Available</span>
            <span class="library-book-badge">Physical Chemistry</span>
          </div>
        </div>

        <div class="library-book-card" style="opacity: 0.5; cursor: not-allowed;" onclick="alert('This book is coming soon! Only Zumdahl General Chemistry is available right now.')">
          <div class="library-book-icon"></div>
          <div class="library-book-title">Chemistry: The Central Science</div>
          <div class="library-book-author">Brown, LeMay & Bursten</div>
          <div class="library-book-edition">14th Edition</div>
          <div class="library-book-meta">
            <span class="library-book-badge" style="background: rgba(255,193,7,0.15); border-color: rgba(255,193,7,0.3); color: #ffc107;"> Coming Soon</span>
          </div>
        </div>

        <div class="library-book-card" onclick="selectBook('klein')">
          <div class="library-book-icon" style="background-image: url('covers/klein.jpg');"></div>
          <div class="library-book-title">Organic Chemistry</div>
          <div class="library-book-author">David Klein</div>
          <div class="library-book-edition">4th Edition</div>
          <div class="library-book-meta">
            <span class="library-book-badge"> Available</span>
            <span class="library-book-badge">Organic</span>
          </div>
        </div>

        <div class="library-book-card" onclick="selectBook('harris')">
          <div class="library-book-icon" style="background-image: url('covers/harris.jpg');"></div>
          <div class="library-book-title">Quantitative Chemical Analysis</div>
          <div class="library-book-author">Daniel C. Harris</div>
          <div class="library-book-edition">10th Edition</div>
          <div class="library-book-meta">
            <span class="library-book-badge"> Available</span>
            <span class="library-book-badge">Analytical</span>
          </div>
        </div>

        <div class="library-book-card" style="opacity: 0.5; cursor: not-allowed;" onclick="alert('This book is coming soon! Only Zumdahl General Chemistry is available right now.')">
          <div class="library-book-icon"></div>
          <div class="library-book-title">Biochemistry</div>
          <div class="library-book-author">Berg, Tymoczko & Stryer</div>
          <div class="library-book-edition">8th Edition</div>
          <div class="library-book-meta">
            <span class="library-book-badge" style="background: rgba(255,193,7,0.15); border-color: rgba(255,193,7,0.3); color: #ffc107;"> Coming Soon</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HEADER (shown after PDF upload) -->
<div class="header" id="main-header">
  <button class="history-toggle-btn" onclick="toggleChatHistory()" title="Menu">
    <svg class="icon" width="20" height="20"><use href="#icon-menu"/></svg>
  </button>
</div>

<!-- MAIN CONTAINER (shown after PDF upload) -->
<div class="main-container" id="main-container">
  <!-- PDF PANEL -->
  <div class="pdf-panel">
    <!-- (ALL YOUR EXISTING PDF SIDEBAR, TOOLBAR, AND VIEWER CODE) -->
    <!-- PDF Sidebar -->
      <div class="pdf-sidebar" id="pdf-sidebar">
        <div class="sidebar-header">
          <div class="sidebar-tabs">
            <button class="sidebar-tab active" onclick="switchSidebarTab('outline')"> Outline</button>
            <button class="sidebar-tab" onclick="switchSidebarTab('thumbnails')"> Pages</button>
          </div>
          <button class="sidebar-close" onclick="toggleSidebar()"><svg class="icon" width="20" height="20"><use href="#icon-close"/></svg></button>
        </div>
        
        <div class="sidebar-search">
          <input type="text" placeholder="Search..." id="sidebar-search" onkeyup="searchSidebar()">
        </div>
        
        <div class="sidebar-content">
          <div class="sidebar-panel active" id="outline-panel">
            <div class="outline-empty"><svg class="icon" width="18" height="18"><use href="#icon-books"/></svg> Select a book to see the outline</div>
          </div>
          
          <div class="sidebar-panel" id="thumbnails-panel">
            <div class="thumbnails-empty"> Select a book to see page thumbnails</div>
          </div>
        </div>
      </div>
      
      <!-- PDF Toolbar -->
      <div class="pdf-toolbar">
        <div class="toolbar-section">
          <!-- Lucide Zoom Out Icon -->
          <button class="toolbar-btn" onclick="zoomOut()" title="Zoom out">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.3-4.3"/>
              <line x1="8" x2="14" y1="11" y2="11"/>
            </svg>
          </button>
          <!-- Lucide Zoom In Icon -->
          <button class="toolbar-btn" onclick="zoomIn()" title="Zoom in">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.3-4.3"/>
              <line x1="11" x2="11" y1="8" y2="14"/>
              <line x1="8" x2="14" y1="11" y2="11"/>
            </svg>
          </button>
          <!-- Lucide Maximize Icon (Fit to Width) -->
          <button class="toolbar-btn" onclick="fitToWidth()" title="Fit to width">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 3h6v6"/>
              <path d="M9 21H3v-6"/>
              <path d="M21 3l-7 7"/>
              <path d="M3 21l7-7"/>
            </svg>
          </button>
          <span class="zoom-level" id="zoom-level">150%</span>
        </div>

        <div class="toolbar-section toolbar-center">
          <!-- Lucide Chevron Left Icon (Previous Page) -->
          <button class="toolbar-btn" onclick="previousPageScroll()" title="Previous page" id="prev-page-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
          </button>
          <div class="page-input-wrapper">
            <input type="number" class="page-input" id="page-input" value="1" min="1" onchange="goToPageInput()" onkeypress="if(event.key==='Enter') goToPageInput()">
            <span class="page-separator">/</span>
            <span class="page-total" id="page-total">-</span>
          </div>
          <!-- Lucide Chevron Right Icon (Next Page) -->
          <button class="toolbar-btn" onclick="nextPageScroll()" title="Next page" id="next-page-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m9 18 6-6-6-6"/>
            </svg>
          </button>
        </div>

        <div class="toolbar-section">
          <!-- Search Icon (already exists) -->
          <button class="toolbar-btn" onclick="searchPDF()" title="Search (Ctrl+F)"><svg class="icon" width="16" height="16"><use href="#icon-search"/></svg></button>
          <!-- Lucide Printer Icon -->
          <button class="toolbar-btn" onclick="printPDF()" title="Print">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
              <path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"/>
              <rect x="6" y="14" width="12" height="8" rx="1"/>
            </svg>
          </button>
          <!-- Lucide Download Icon -->
          <button class="toolbar-btn" onclick="downloadPDF()" title="Download">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
          </button>
          <div class="toolbar-divider"></div>
          <!-- Library Icon -->
          <button class="toolbar-btn" onclick="openLibraryModal()" title="Browse Library">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
            </svg>
          </button>
          <!-- Keep the hidden file input for future use if needed -->
          <input type="file" id="pdf-upload" accept=".pdf" style="display:none;" onchange="loadPDF(event)">
        </div>
      </div>

      <!-- Search Overlay -->
      <div class="search-overlay" id="search-overlay">
        <input type="text" class="search-input" id="search-input" placeholder="Search in document..." onkeyup="handleSearch(event)">
        <div class="search-results" id="search-results"></div>
      </div>

      <!-- PDF Viewer -->
      <div class="pdf-viewer" id="pdf-viewer">
        <div class="pdf-placeholder">
          <h2 style="color:#aaa; margin-bottom:16px;"><svg class="icon" width="18" height="18"><use href="#icon-document"/></svg> No Textbook Selected</h2>
          <p style="color:#666; margin-bottom:20px;">Browse our library to select a chemistry textbook!</p>
          <button class="upload-btn" onclick="openLibraryModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;">
              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
            </svg>
            Browse Library
          </button>
        </div>
        <canvas id="pdf-canvas"></canvas>
      </div>
  </div>

  <!-- CHAT PANEL -->
  <div class="chat-panel">
    <!-- (ALL YOUR EXISTING CHAT CODE) -->
    <!-- Chat Messages -->
      <div class="chat-messages" id="chat-messages">
        <div class="message ai">
          <div class="message-bubble">
            <strong>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                <path d="M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2"/>
                <path d="M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2"/>
                <path d="M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8"/>
                <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
              </svg>
              Welcome to Chunks!
            </strong>
            <p>Select your textbook from the library and ask questions. Try: "What is $\ce{H2O}$?" or "create flashcards for stoichiometry"</p>
          </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
          <div class="typing-dots">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>

      <!-- Molecule Bubbles Container -->
      <div id="molecule-bubbles-container"></div>

      <!-- Molecule Modal -->
      <div id="molecule-modal" class="molecule-modal">
          <div class="molecule-modal-content-enhanced">
              <!-- Enhanced Header with Glassmorphism -->
              <div class="molecule-modal-header-enhanced">
                  <div class="molecule-header-left">
                      <div class="molecule-icon-pulse"></div>
                      <div>
                          <h3 id="modal-molecule-name" class="molecule-name-enhanced">Molecule Viewer</h3>
                          <p id="modal-molecule-formula" class="molecule-formula">Loading...</p>
                      </div>
                  </div>
                  <button class="modal-close-btn-enhanced" onclick="closeMoleculeModal()">
                      <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                  </button>
              </div>
              
              <!-- 3D Viewer Area -->
              <div id="modal-molecule-viewer" class="modal-viewer-3d-enhanced"></div>
              
              <!-- Enhanced Controls with Style Buttons -->
              <div class="molecule-controls-enhanced">
                  <div class="control-section">
                      <label class="control-label">Viewing Style</label>
                      <div class="style-button-group">
                          <button onclick="applyModalStyle('stick')" class="style-btn" id="style-stick" title="Stick Model">
                              <i data-lucide="minus" style="width: 16px; height: 16px;"></i>
                              Stick
                          </button>
                          <button onclick="applyModalStyle('ball-stick')" class="style-btn active" id="style-ball-stick" title="Ball & Stick">
                              <i data-lucide="circle-dot" style="width: 16px; height: 16px;"></i>
                              Ball & Stick
                          </button>
                          <button onclick="applyModalStyle('sphere')" class="style-btn" id="style-sphere" title="Space-Filling">
                              <i data-lucide="circle" style="width: 16px; height: 16px;"></i>
                              Space-Fill
                          </button>
                      </div>
                  </div>
                  
                  <div class="control-section">
                      <label class="control-label">Display Options</label>
                      <div class="toggle-group">
                          <label class="toggle-switch">
                              <input type="checkbox" id="show-lone-pairs" onchange="toggleLonePairs(this.checked)">
                              <span class="toggle-slider"></span>
                              <span class="toggle-label">Lone Pairs</span>
                          </label>
                          <label class="toggle-switch">
                              <input type="checkbox" id="show-labels" onchange="toggleLabels(this.checked)">
                              <span class="toggle-slider"></span>
                              <span class="toggle-label">Labels</span>
                          </label>
                      </div>
                  </div>
                  
                  <div class="control-section">
                      <label class="control-label">Actions</label>
                      <div class="action-button-group">
                          <button onclick="resetModalView()" class="action-btn">
                              <i data-lucide="rotate-ccw" style="width: 18px; height: 18px;"></i>
                              Reset View
                          </button>
                          <button onclick="downloadModalMolecule()" class="action-btn">
                              <i data-lucide="download" style="width: 18px; height: 18px;"></i>
                              Download
                          </button>
                      </div>
                  </div>
              </div>
              
              <!-- Molecular Properties Panel -->
              <div class="molecule-properties-panel" id="molecule-properties">
                  <div class="properties-header">
                      <i data-lucide="info" style="width: 16px; height: 16px;"></i>
                      Molecular Properties
                  </div>
                  <div class="properties-grid" id="properties-content">
                      <div class="property-item">
                          <span class="property-label">Formula:</span>
                          <span class="property-value" id="prop-formula">-</span>
                      </div>
                      <div class="property-item">
                          <span class="property-label">Molecular Weight:</span>
                          <span class="property-value" id="prop-weight">-</span>
                      </div>
                      <div class="property-item">
                          <span class="property-label">Atoms:</span>
                          <span class="property-value" id="prop-atoms">-</span>
                      </div>
                      <div class="property-item">
                          <span class="property-label">Bonds:</span>
                          <span class="property-value" id="prop-bonds">-</span>
                      </div>
                  </div>
              </div>
              
              <!-- Enhanced Atom Legend -->
              <div class="atom-legend-enhanced">
                  <div class="legend-item-enhanced">
                      <span class="atom-dot-enhanced" style="background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);"></span>
                      <span>Hydrogen (H)</span>
                  </div>
                  <div class="legend-item-enhanced">
                      <span class="atom-dot-enhanced" style="background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);"></span>
                      <span>Oxygen (O)</span>
                  </div>
                  <div class="legend-item-enhanced">
                      <span class="atom-dot-enhanced" style="background: linear-gradient(135deg, #909090 0%, #404040 100%);"></span>
                      <span>Carbon (C)</span>
                  </div>
                  <div class="legend-item-enhanced">
                      <span class="atom-dot-enhanced" style="background: linear-gradient(135deg, #5555ff 0%, #0000cc 100%);"></span>
                      <span>Nitrogen (N)</span>
                  </div>
                  <div class="legend-item-enhanced">
                      <span class="atom-dot-enhanced" style="background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); opacity: 0.6;"></span>
                      <span>Lone Pairs</span>
                  </div>
              </div>
          </div>
      </div>

      <!-- Compact Controls Bar -->
      <div class="compact-controls-bar">
        <div class="mode-compact">
          <label>
            <!-- Lucide Graduation Cap Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z"/>
              <path d="M22 10v6"/>
              <path d="M6 12.5V16a6 3 0 0 0 12 0v-3.5"/>
            </svg>
            Mode:
          </label>
          <select id="mode-select" onchange="setMode(this.value)" class="mode-dropdown">
            <option value="study" selected>Study</option>
            <option value="exam">Exam</option>
            <option value="practice">Practice</option>
            <option value="summary">Summary</option>
          </select>
        </div>
        
        <div class="complexity-compact">
          <label>
            <!-- Lucide Gauge Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 14 4-4"/>
              <path d="M3.34 19a10 10 0 1 1 17.32 0"/>
            </svg>
            Level: <span id="complexity-value-compact">5</span>
          </label>
          <input 
            type="range" 
            min="1" 
            max="10" 
            value="5" 
            class="complexity-slider-compact" 
            id="complexity-slider-compact"
            oninput="updateComplexityCompact(this.value)"
          >
        </div>
      </div>
      
      <!-- Chat Input -->
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <button class="clear-chat-btn" onclick="clearChat()" title="Clear chat messages">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"/>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              <line x1="10" x2="10" y1="11" y2="17"/>
              <line x1="14" x2="14" y1="11" y2="17"/>
            </svg>
            Clear
          </button>
          <input type="text" class="chat-input" id="chat-input" placeholder="Ask: What is stoichiometry?" onkeypress="if(event.key==='Enter') sendMessage()">
          <button class="send-btn" onclick="sendMessage()" id="send-btn">Send</button>
        </div>
      </div>
  </div>
</div>

<script>
  // ALL YOUR EXISTING JAVASCRIPT (from your original file)
  // API Configuration - Auto-detects local vs production
// API Configuration
const API_URL = (() => {
  // Auto-detect environment
  const hostname = window.location.hostname;
  
  // Local development
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://localhost:5000';
  }
  
  // Production - UPDATE THIS AFTER DEPLOYING BACKEND!
  return 'https://web-production-f4867.up.railway.app';
})();

console.log(' Environment:', window.location.hostname);
console.log(' API URL:', API_URL);

  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  let pdfDoc = null;
  let currentPdfName = null;
  let pageNum = 1;
  let pageRendering = false;
  let pageNumPending = null;
  let scale = 1.5;
  let outlineData = [];
  let currentPage = 1;
  let renderedPages = new Set();
  let isRendering = false;
  let currentStudyMode = 'study';

  const modeDescriptions = {
    study: {
      emoji: '',
      name: 'Study Mode',
      desc: 'Simple explanations with examples'
    },
    exam: {
      emoji: '',
      name: 'Exam Mode',
      desc: 'Test your knowledge with questions'
    },
    practice: {
      emoji: '',
      name: 'Practice Mode',
      desc: 'Solve problems step-by-step'
    },
    summary: {
      emoji: '',
      name: 'Summary Mode',
      desc: 'Quick review with key points'
    }
  };

  function setMode(mode) {
    currentStudyMode = mode;
    const modeInfo = modeDescriptions[mode];
    console.log(` Mode: ${modeInfo.name}`);
  }

  // ==========================================
  // LIBRARY MODAL FUNCTIONS
  // ==========================================
  
  function openLibraryModal() {
    document.getElementById('library-modal').classList.add('active');
  }

  function closeLibraryModal() {
    document.getElementById('library-modal').classList.remove('active');
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('library-modal');
    if (event.target === modal) {
      closeLibraryModal();
    }
  });

  // Book selection and configuration
  const bookLibrary = {
    zumdahl: {
      name: 'General Chemistry',
      author: 'Zumdahl & Zumdahl',
      edition: '9th Edition',
      chunksFile: 'chunks_with_embeddings.json',
      pdfFile: 'zumdahl_chemistry.pdf'
    },
    atkins: {
    name: 'Physical Chemistry',
    author: 'Atkins & de Paula',
    edition: '8th Edition',
    chunksFile: 'atkins_chunks_with_embeddings.json',
    pdfFile: 'atkins_physical_chemistry.pdf'
  },
    brown: {
      name: 'Chemistry: The Central Science',
      author: 'Brown, LeMay & Bursten',
      edition: '14th Edition',
      chunksFile: 'brown_chunks_with_embeddings.json',
      pdfFile: 'brown_chemistry.pdf'
    },
    klein: {
    name: 'Organic Chemistry',
    author: 'David Klein',
    edition: '4th Edition',
    chunksFile: 'klein_chunks_with_embeddings.json',
    pdfFile: 'klein_organic_chemistry.pdf'
  },
    harris: {
      name: 'Quantitative Chemical Analysis',
      author: 'Daniel C. Harris',
      edition: '10th Edition',
      chunksFile: 'harris_chunks_with_embeddings.json',
      pdfFile: 'harris_quantitative_analysis.pdf'
    },
    biochemistry: {
      name: 'Biochemistry',
      author: 'Berg, Tymoczko & Stryer',
      edition: '8th Edition',
      chunksFile: 'biochemistry_chunks_with_embeddings.json',
      pdfFile: 'biochemistry.pdf'
    }
  };

  async function selectBook(bookId) {
    const book = bookLibrary[bookId];
    if (!book) {
      alert('Book not found!');
      return;
    }

    console.log(` Selected: ${book.name} by ${book.author}`);
    
    // Close the modal
    closeLibraryModal();
    
    // Show loading state
    const loadingMsg = `Loading ${book.name}...`;
    console.log(loadingMsg);
    
    // Tell the server to load this book's chunks
    try {
      const response = await fetch(`${API_URL}/load-book`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookId: bookId })
      });
      
      const result = await response.json();
      
      if (result.success) {
        console.log(` Book chunks loaded: ${result.chunks_count} chunks`);
        
        // Hide welcome screen and show main interface
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('main-container').style.display = 'flex';
        
        // Now try to load the PDF file if it exists
        if (book.pdfFile) {
          console.log(` Loading PDF: ${book.pdfFile}`);
          await loadBookPDFFromServer(result.pdf_url, result.book_name);
        } else {
          // No PDF file, just show chunks are loaded
          alert(` ${book.name} loaded successfully!\n${result.chunks_count} sections available.\n\nNote: PDF viewer not available for this book.`);
        }
      } else {
        alert(` Failed to load book: ${result.error}`);
      }
    } catch (error) {
      console.error('Error loading book:', error);
      alert(` Error: ${error.message}`);
    }
  }

  async function loadBookPDFFromServer(pdfFileName, bookName) {
    try {
      // Get the current book ID from the bookLibrary
      let bookId = null;
      for (const [id, book] of Object.entries(bookLibrary)) {
        if (book.name === bookName) {
          bookId = id;
          break;
        }
      }
      
      if (!bookId) {
        throw new Error('Book ID not found');
      }
      
      // Load PDF from server endpoint
      const pdfPath = pdfFileName;
      
      console.log(` Attempting to load PDF from: ${pdfPath}`);
      
      const loadingTask = pdfjsLib.getDocument(pdfPath);
      pdfDoc = await loadingTask.promise;
      currentPdfName = bookName;
      
      console.log(` PDF loaded: ${pdfDoc.numPages} pages`);
      
      // Update UI
      document.getElementById('page-total').textContent = pdfDoc.numPages;
      document.getElementById('page-input').max = pdfDoc.numPages;
      
      // Hide placeholder and setup viewer
      const viewer = document.getElementById('pdf-viewer');
      const placeholder = viewer.querySelector('.pdf-placeholder');
      if (placeholder) {
        placeholder.style.display = 'none';
      }
      
      viewer.innerHTML = '';
      renderedPages.clear();
      
      // Create pages container
      const pagesContainer = document.createElement('div');
      pagesContainer.id = 'pdf-pages-container';
      pagesContainer.style.cssText = 'display:flex; flex-direction:column; gap:20px; padding:20px; align-items:center; width:100%;';
      viewer.appendChild(pagesContainer);
      
      // Render first few pages
      for (let i = 1; i <= Math.min(3, pdfDoc.numPages); i++) {
        await renderPageScroll(i);
      }
      
      // Add success message
      addChatMessage('<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>Textbook loaded! Scroll to read pages.', 'ai');
      
      // Extract outline and generate thumbnails
      await extractOutline();
      await generateThumbnails();
      
      // Setup scroll handling
      viewer.addEventListener('scroll', handleScroll);
      updatePageInput();
      
      // Update progress tracking
      const progress = getProgressData();
      if (!progress.pdfDocuments[currentPdfName]) {
        progress.pdfDocuments[currentPdfName] = {
          pagesRead: [],
          totalPages: pdfDoc.numPages,
          questionsAsked: 0,
          lastAccessed: new Date().toISOString(),
          timeSpent: 0
        };
      }
      progress.pdfDocuments[currentPdfName].totalPages = pdfDoc.numPages;
      saveProgressData(progress);
      startStudySession();
      addRecentActivity('pdf_load', `Loaded ${currentPdfName}`, currentPdfName);
      
      // Update Books tab
      renderChunksBooks();
      
    } catch (error) {
      console.warn(` Could not load PDF file: ${error.message}`);
      console.log(' Book chunks are loaded - you can still ask questions!');
      
      // Show a friendly message
      const pdfViewer = document.getElementById('pdf-viewer');
      pdfViewer.innerHTML = `
        <div class="pdf-placeholder">
          <h2 style="color:#aaa; margin-bottom:16px;"> ${bookName}</h2>
          <p style="color:#666; margin-bottom:12px;">Textbook content loaded successfully!</p>
          <p style="color:#888; font-size:14px;">PDF viewer not available, but you can still:</p>
          <ul style="color:#999; font-size:13px; text-align:left; max-width:300px; margin:16px auto;">
            <li style="margin:8px 0;"> Ask questions about the textbook</li>
            <li style="margin:8px 0;"> Generate flashcards</li>
            <li style="margin:8px 0;"> Get AI explanations</li>
          </ul>
        </div>
      `;
    }
  }

  function toggleSidebar() {
    document.getElementById('pdf-sidebar').classList.toggle('open');
  }

  function switchSidebarTab(tab) {
    document.querySelectorAll('.sidebar-tab').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.sidebar-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(`${tab}-panel`).classList.add('active');
  }

  function searchSidebar() {
    const search = document.getElementById('sidebar-search').value.toLowerCase();
    document.querySelectorAll('.outline-item').forEach(item => {
      const title = item.querySelector('.outline-title').textContent.toLowerCase();
      item.style.display = title.includes(search) ? 'flex' : 'none';
    });
  }

  async function extractOutline() {
    if (!pdfDoc) return;
    const outlinePanel = document.getElementById('outline-panel');
    outlinePanel.innerHTML = '<div class="outline-loading"><div class="loading-spinner"></div><div style="color:#888;">Extracting outline...</div></div>';
    try {
      const outline = await pdfDoc.getOutline();
      if (outline && outline.length > 0) {
        console.log(' Found PDF outline:', outline.length, 'items');
        await buildOutlineFromPDF(outline);
      } else {
        outlinePanel.innerHTML = '<div class="outline-empty"><svg class="icon" width="18" height="18"><use href="#icon-books"/></svg> This PDF has no outline/bookmarks.<br><br>Try the Pages tab to navigate!</div>';
      }
    } catch (err) {
      outlinePanel.innerHTML = '<div class="outline-empty"> Could not extract outline</div>';
    }
  }

  async function buildOutlineFromPDF(outline, level = 1) {
    const outlinePanel = document.getElementById('outline-panel');
    outlineData = [];
    outlinePanel.innerHTML = '';
    await processOutlineItems(outline, level, outlinePanel);
    if (outlineData.length === 0) {
      outlinePanel.innerHTML = '<div class="outline-empty"><svg class="icon" width="18" height="18"><use href="#icon-books"/></svg> No valid outline items found</div>';
    }
    // Update Contents tab
    renderChunksContents();
  }

  async function processOutlineItems(items, level, container) {
    for (const item of items) {
      try {
        let pageNumber = null;
        if (item.dest) {
          if (typeof item.dest === 'string') {
            const dest = await pdfDoc.getDestination(item.dest);
            if (dest && dest[0]) {
              const pageIndex = await pdfDoc.getPageIndex(dest[0]);
              pageNumber = pageIndex + 1;
            }
          } else if (Array.isArray(item.dest) && item.dest[0]) {
            const pageIndex = await pdfDoc.getPageIndex(item.dest[0]);
            pageNumber = pageIndex + 1;
          }
        }
        if (pageNumber) {
          const itemDiv = document.createElement('div');
          itemDiv.className = `outline-item level-${level}`;
          itemDiv.onclick = () => {
            jumpToPage(pageNumber);
            if (window.innerWidth < 768) toggleSidebar();
          };
          itemDiv.innerHTML = `<div class="outline-title">${escapeHtml(item.title)}</div><div class="outline-page">${pageNumber}</div>`;
          container.appendChild(itemDiv);
          outlineData.push({ title: item.title, page: pageNumber, level: level });
        }
        if (item.items && item.items.length > 0 && level < 3) {
          await processOutlineItems(item.items, level + 1, container);
        }
      } catch (err) {}
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function generateThumbnails() {
    if (!pdfDoc) return;
    const thumbnailsPanel = document.getElementById('thumbnails-panel');
    thumbnailsPanel.innerHTML = '<div class="outline-loading"><div class="loading-spinner"></div><div style="color:#888;">Generating thumbnails...</div></div>';
    const grid = document.createElement('div');
    grid.className = 'thumbnails-grid';
    const maxThumbs = Math.min(20, pdfDoc.numPages);
    for (let i = 1; i <= maxThumbs; i++) {
      const thumbItem = await createThumbnail(i);
      grid.appendChild(thumbItem);
    }
    thumbnailsPanel.innerHTML = '';
    thumbnailsPanel.appendChild(grid);
    if (pdfDoc.numPages > maxThumbs) {
      const loadMore = document.createElement('div');
      loadMore.style.cssText = 'text-align:center; padding:20px; color:#888; cursor:pointer;';
      loadMore.textContent = `+ Load ${pdfDoc.numPages - maxThumbs} more pages`;
      loadMore.onclick = () => loadMoreThumbnails(maxThumbs + 1, grid, loadMore);
      thumbnailsPanel.appendChild(loadMore);
    }
  }

  async function createThumbnail(pageNumber) {
    const page = await pdfDoc.getPage(pageNumber);
    const viewport = page.getViewport({ scale: 0.3 });
    const canvas = document.createElement('canvas');
    canvas.className = 'thumbnail-canvas';
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    await page.render({ canvasContext: context, viewport: viewport }).promise;
    const thumbItem = document.createElement('div');
    thumbItem.className = 'thumbnail-item';
    if (pageNumber === pageNum) thumbItem.classList.add('active');
    thumbItem.onclick = () => {
      jumpToPage(pageNumber);
      document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
      thumbItem.classList.add('active');
      if (window.innerWidth < 768) toggleSidebar();
    };
    const label = document.createElement('div');
    label.className = 'thumbnail-label';
    label.textContent = `Page ${pageNumber}`;
    thumbItem.appendChild(canvas);
    thumbItem.appendChild(label);
    return thumbItem;
  }

  async function loadMoreThumbnails(startPage, grid, loadMoreBtn) {
    loadMoreBtn.textContent = 'Loading...';
    const endPage = Math.min(startPage + 20, pdfDoc.numPages);
    for (let i = startPage; i <= endPage; i++) {
      const thumbItem = await createThumbnail(i);
      grid.appendChild(thumbItem);
    }
    if (endPage < pdfDoc.numPages) {
      loadMoreBtn.textContent = `+ Load ${pdfDoc.numPages - endPage} more pages`;
      loadMoreBtn.onclick = () => loadMoreThumbnails(endPage + 1, grid, loadMoreBtn);
    } else {
      loadMoreBtn.remove();
    }
  }

  function saveChatHistory() {
    const messages = [];
    document.querySelectorAll('.message').forEach(msg => {
      if (!msg.querySelector('.typing-indicator')) {
        const bubble = msg.querySelector('.message-bubble');
        messages.push({
          sender: msg.classList.contains('user') ? 'user' : 'ai',
          html: bubble.innerHTML
        });
      }
    });
    localStorage.setItem('eightysix_chat_history', JSON.stringify(messages));
  }

  function loadChatHistory() {
    const saved = localStorage.getItem('eightysix_chat_history');
    if (!saved) return;
    const messages = JSON.parse(saved);
    const chat = document.getElementById('chat-messages');
    const typing = document.getElementById('typing-indicator');
    chat.innerHTML = '';
    chat.appendChild(typing);
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = `message ${msg.sender}`;
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = msg.html;
      const pageRefs = bubble.querySelectorAll('.page-reference');
      pageRefs.forEach(ref => {
        const pageMatch = ref.textContent.match(/\d+/);
        if (pageMatch) {
          ref.onclick = () => jumpToPage(parseInt(pageMatch[0]));
        }
      });
      div.appendChild(bubble);
      chat.insertBefore(div, typing);
    });
    chat.scrollTop = chat.scrollHeight;
    if (typeof MathJax !== 'undefined') {
      setTimeout(() => renderMath(chat), 500);
    }
  }

  async function loadPDF(event) {
    const file = event.target.files[0];
    if (!file || file.type !== 'application/pdf') {
      alert('Please select a PDF file!');
      return;
    }

    // TRANSITION FROM WELCOME TO SPLIT-SCREEN
    document.getElementById('welcome-screen').classList.add('hidden');
    document.getElementById('main-header').classList.add('active');
    document.getElementById('main-container').classList.add('active');

    const reader = new FileReader();
    reader.onload = async function() {
      const typedarray = new Uint8Array(this.result);
      pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
      document.getElementById('page-total').textContent = pdfDoc.numPages;
      document.querySelector('.pdf-placeholder').style.display = 'none';
      const viewer = document.getElementById('pdf-viewer');
      viewer.innerHTML = '';
      renderedPages.clear();
      const pagesContainer = document.createElement('div');
      pagesContainer.id = 'pdf-pages-container';
      pagesContainer.style.cssText = 'display:flex; flex-direction:column; gap:20px; padding:20px; align-items:center; width:100%;';
      viewer.appendChild(pagesContainer);
      for (let i = 1; i <= Math.min(3, pdfDoc.numPages); i++) {
        await renderPageScroll(i);
      }
      addChatMessage('<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>Textbook loaded! Scroll to read pages.', 'ai');
      
      // Track PDF load and start study session
      currentPdfName = file.name.replace('.pdf', '');
      const progress = getProgressData();
      if (!progress.pdfDocuments[currentPdfName]) {
        progress.pdfDocuments[currentPdfName] = {
          pagesRead: [],  // Use array instead of Set
          totalPages: pdfDoc.numPages,
          questionsAsked: 0,
          lastAccessed: new Date().toISOString(),
          timeSpent: 0
        };
        saveProgressData(progress);
      }
      progress.pdfDocuments[currentPdfName].totalPages = pdfDoc.numPages;
      saveProgressData(progress);
      startStudySession();
      addRecentActivity('pdf_load', `Loaded ${currentPdfName}`, currentPdfName);
      
      extractOutline();
      generateThumbnails();
      viewer.addEventListener('scroll', handleScroll);
      updatePageInput();

      // Update Books tab
      renderChunksBooks();
    };
    reader.readAsArrayBuffer(file);
  }

  async function renderPageScroll(pageNumber) {
    if (renderedPages.has(pageNumber) || !pdfDoc) return;
    if (pageNumber < 1 || pageNumber > pdfDoc.numPages) return;
    renderedPages.add(pageNumber);
    const page = await pdfDoc.getPage(pageNumber);
    const viewport = page.getViewport({ scale: scale });
    const canvas = document.createElement('canvas');
    canvas.className = 'pdf-page-canvas';
    canvas.dataset.pageNumber = pageNumber;
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    const pageContainer = document.createElement('div');
    pageContainer.className = 'pdf-page-container';
    pageContainer.dataset.pageNumber = pageNumber;
    pageContainer.style.cssText = 'position:relative; box-shadow:0 4px 20px rgba(0,0,0,0.5); background:#fff;';
    const pageLabel = document.createElement('div');
    pageLabel.textContent = `Page ${pageNumber}`;
    pageLabel.style.cssText = 'position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); color:white; padding:4px 12px; border-radius:4px; font-size:12px; font-weight:600; z-index:10;';
    pageContainer.appendChild(pageLabel);
    pageContainer.appendChild(canvas);
    const container = document.getElementById('pdf-pages-container');
    const existingPages = Array.from(container.children);
    let inserted = false;
    for (let i = 0; i < existingPages.length; i++) {
      const existingPageNum = parseInt(existingPages[i].dataset.pageNumber);
      if (existingPageNum > pageNumber) {
        container.insertBefore(pageContainer, existingPages[i]);
        inserted = true;
        break;
      }
    }
    if (!inserted) {
      container.appendChild(pageContainer);
    }
    await page.render({ canvasContext: context, viewport: viewport }).promise;
    
    // Track page read - with error handling
    try {
      if (currentPdfName) {
        console.log(` Tracking page ${pageNumber} in ${currentPdfName}`);
        trackPageRead(pageNumber, currentPdfName);
        // Refresh sidebar if it's open
        if (currentChunksTab === 'progress') {
          renderSidebarProgress();
        }
      } else {
        console.warn(' currentPdfName not set, page not tracked');
      }
    } catch (error) {
      console.error('Page tracking error:', error);
      // Don't let tracking errors break PDF rendering
    }
  }

  function jumpToPage(pageNumber) {
    if (!pdfDoc || pageNumber < 1 || pageNumber > pdfDoc.numPages) return;
    if (!renderedPages.has(pageNumber)) {
      renderPageScroll(pageNumber);
    }
    setTimeout(() => {
      const pageContainer = document.querySelector(`[data-page-number="${pageNumber}"]`);
      if (pageContainer) {
        pageContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        currentPage = pageNumber;
        updatePageInput();
      }
    }, 300);
  }

  function handleScroll() {
    if (isRendering || !pdfDoc) return;
    const viewer = document.getElementById('pdf-viewer');
    const scrollTop = viewer.scrollTop;
    const scrollHeight = viewer.scrollHeight;
    const clientHeight = viewer.clientHeight;
    updateCurrentPage();
    if (scrollTop + clientHeight > scrollHeight - 1000) {
      loadMorePages();
    }
  }

  function updateCurrentPage() {
    const viewer = document.getElementById('pdf-viewer');
    const viewerTop = viewer.scrollTop;
    const viewerMiddle = viewerTop + viewer.clientHeight / 2;
    const pageContainers = document.querySelectorAll('.pdf-page-container');
    let closestPage = 1;
    let closestDistance = Infinity;
    pageContainers.forEach(container => {
      const rect = container.getBoundingClientRect();
      const containerTop = container.offsetTop;
      const containerMiddle = containerTop + rect.height / 2;
      const distance = Math.abs(containerMiddle - viewerMiddle);
      if (distance < closestDistance) {
        closestDistance = distance;
        closestPage = parseInt(container.dataset.pageNumber);
      }
    });
    if (closestPage !== currentPage) {
      currentPage = closestPage;
      updatePageInput();
      document.querySelectorAll('.thumbnail-item').forEach((thumb, idx) => {
        thumb.classList.toggle('active', idx + 1 === currentPage);
      });
    }
  }

  async function loadMorePages() {
    if (isRendering || !pdfDoc) return;
    isRendering = true;
    let maxRendered = Math.max(...Array.from(renderedPages));
    for (let i = maxRendered + 1; i <= Math.min(maxRendered + 3, pdfDoc.numPages); i++) {
      await renderPageScroll(i);
    }
    isRendering = false;
  }

  function renderMath(element) {
    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
      MathJax.typesetPromise([element]).catch(err => console.log('MathJax error'));
    }
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    addChatMessage(msg, 'user');
    
    // Track question (but not for special commands) - with error handling
    try {
      const isCommand = msg.toLowerCase() === 'clear session' || 
                        ['progress', 'stats', 'statistics', 'dashboard'].some(k => msg.toLowerCase().includes(k)) ||
                        ['flashcard', 'flash card', 'quiz me'].some(k => msg.toLowerCase().includes(k));
      if (!isCommand && currentPdfName) {
        trackQuestion(msg, currentPdfName);
      }
    } catch (error) {
      console.error('Tracking error:', error);
      // Don't let tracking errors break chat functionality
    }
    
    if (msg.toLowerCase() === 'clear session') {
      localStorage.clear();
      location.reload();
      return;
    }
    const flashcardKeywords = ['flashcard', 'flash card', 'quiz me', 'study cards'];
    const isFlashcardRequest = flashcardKeywords.some(k => msg.toLowerCase().includes(k));
    if (isFlashcardRequest) {
      generateFlashcardsInChat(extractTopic(msg));
      return;
    }
    const progressKeywords = ['progress', 'stats', 'statistics', 'my progress', 'show progress', 'view stats', 'study stats', 'dashboard'];
    const isProgressRequest = progressKeywords.some(k => msg.toLowerCase().includes(k));
    if (isProgressRequest) {
      console.log(' Progress request detected:', msg);
      showProgressDashboard();
      return;
    }
    if (!pdfDoc) {
      alert('Please select a book from the library first!');
      return;
    }
    const typing = document.getElementById('typing-indicator');
    typing.classList.add('active');
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    
    try {
      console.log(' Sending message to backend:', msg);
      console.log(' API URL:', API_URL);
      console.log(' Mode:', currentStudyMode, 'Complexity:', currentComplexity);
      
      const res = await fetch(`${API_URL}/ask`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: msg, mode: currentStudyMode, complexity: currentComplexity })
      });
      
      console.log(' Response status:', res.status);
      console.log(' Response ok:', res.ok);
      
      const data = await res.json();
      console.log(' Response data:', data);
      
      if (data.success) {
        console.log(' Success! Adding message to chat...');
        console.log(' Response text:', data.answer?.substring(0, 100) + '...');
        
        addChatMessage(data.answer, 'ai', data.source);
        console.log(' Message added to chat!');
        
        if (data.source?.page) {
          setTimeout(() => jumpToPage(data.source.page), 500);
        }

        if (data.highlight) {
          setTimeout(() => highlightSentence(data.highlight), 900);
        }
        
        
        if (data.complexity_used) {
          console.log(` Response at complexity level: ${data.complexity_used}/10`);
        }
        
        if (data.molecules && data.molecules.length > 0) {
          console.log(' Creating molecule bubbles:', data.molecules);
          data.molecules.forEach((molecule, index) => {
            setTimeout(() => {
              createMoleculeBubble(molecule, index);
            }, index * 300);
          });
        }
        if (data.source && data.source.page) {
          console.log(' Jumping to page:', data.source.page);
          setTimeout(() => jumpToPage(data.source.page), 500);
        }
      } else {
        console.error(' Backend returned success: false');
        addChatMessage(' AI had trouble processing your request.', 'ai');
      }
    } catch (e) {
      console.error(' Chat error:', e);
      console.error(' Error stack:', e.stack);
      addChatMessage(' Connection error: ' + e.message, 'ai');
    } finally {
      console.log(' Cleaning up - removing typing indicator...');
      typing.classList.remove('active');
      sendBtn.disabled = false;
      input.focus();
      console.log(' Cleanup complete!');
    }
  }

  function extractTopic(message) {
    return message.toLowerCase().replace(/create|make|generate|give me|show me|flashcards?|flash cards?|quiz|study cards?|for|about|on/gi, '').trim() || 'general chemistry';
  }

  async function generateFlashcardsInChat(topic) {
    const typing = document.getElementById('typing-indicator');
    typing.classList.add('active');
    addChatMessage(`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m6.08 9.5-3.5 1.6a1 1 0 0 0 0 1.81l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9a1 1 0 0 0 0-1.83l-3.5-1.59"/><path d="m6.08 14.5-3.5 1.6a1 1 0 0 0 0 1.81l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9a1 1 0 0 0 0-1.83l-3.5-1.59"/></svg>Creating flashcards for "${topic}"... (3-5 seconds)`, 'ai');
    try {
      const response = await fetch(`${API_URL}/generate-flashcards`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic, count: 10 })
      });
      const data = await response.json();
      if (data.success && data.flashcards) {
        typing.classList.remove('active');
        displayFlashcardsInChat(data.flashcards, topic);
      } else {
        typing.classList.remove('active');
        addChatMessage(` Could not generate flashcards: ${data.error || 'Unknown error'}`, 'ai');
      }
    } catch (error) {
      typing.classList.remove('active');
      addChatMessage(` Error: ${error.message}`, 'ai');
    }
  }

  // ==========================================
  // PROGRESS TRACKING SYSTEM
  // ==========================================
  
  function getProgressData() {
    const saved = localStorage.getItem('chunks_progress');
    let progress;
    
    if (saved) {
      progress = JSON.parse(saved);
      // Migration: ensure all fields exist
      if (typeof progress.totalPagesRead === 'undefined') progress.totalPagesRead = 0;
      if (typeof progress.totalQuestions === 'undefined') progress.totalQuestions = 0;
      if (typeof progress.totalStudyTime === 'undefined') progress.totalStudyTime = 0;
      if (!progress.pdfDocuments) progress.pdfDocuments = {};
      if (!progress.recentActivity) progress.recentActivity = [];
      if (typeof progress.studyStreak === 'undefined') progress.studyStreak = 0;
    } else {
      progress = {
        // Flashcard tracking
        topics: {},          // Per-topic flashcard progress
        totalSessions: 0,    // Total flashcard sessions
        totalCards: 0,       // Total cards studied
        totalCorrect: 0,     // Total correct answers
        totalIncorrect: 0,   // Total incorrect answers
        bestStreak: 0,       // Best streak ever
        studyStreak: 0,      // Current consecutive days
        
        // PDF & General tracking
        pdfDocuments: {},    // Per-PDF progress
        totalPagesRead: 0,   // Total pages viewed
        totalStudyTime: 0,   // Total time in minutes
        totalQuestions: 0,   // Total chat questions asked
        sessionStartTime: null, // Current session start
        lastStudied: null,   // Last study date
        
        // Activity logs
        recentActivity: []   // Recent study activities (last 20)
      };
    }
    
    return progress;
  }
  
  function saveProgressData(data) {
    localStorage.setItem('chunks_progress', JSON.stringify(data));
  }
  
  function startStudySession() {
    const progress = getProgressData();
    progress.sessionStartTime = Date.now();
    saveProgressData(progress);
    console.log(' Study session started at:', new Date(progress.sessionStartTime).toLocaleTimeString());
  }
  
  function updateStudyTime() {
    const progress = getProgressData();
    console.log(' updateStudyTime called. sessionStartTime:', progress.sessionStartTime);
    
    if (progress.sessionStartTime) {
      const sessionTime = Math.round((Date.now() - progress.sessionStartTime) / 60000); // minutes
      
      if (sessionTime > 0) {
        progress.totalStudyTime += sessionTime;
        console.log(` Study time updated: +${sessionTime}m, Total: ${progress.totalStudyTime}m`);
      } else {
        console.log(' Less than 1 minute elapsed, no update');
      }
      
      progress.sessionStartTime = Date.now(); // Reset for next interval
      saveProgressData(progress);
    } else {
      console.warn(' sessionStartTime not set, cannot track time');
    }
  }
  
  function trackPageRead(pageNum, pdfName) {
    try {
      const progress = getProgressData();
      
      // Initialize totalPagesRead if undefined
      if (typeof progress.totalPagesRead === 'undefined') {
        progress.totalPagesRead = 0;
      }
      
      if (!progress.pdfDocuments[pdfName]) {
        progress.pdfDocuments[pdfName] = {
          pagesRead: [],  // Use array instead of Set
          totalPages: 0,
          questionsAsked: 0,
          lastAccessed: null,
          timeSpent: 0
        };
      }
      
      const doc = progress.pdfDocuments[pdfName];
      // Convert to Set for checking, back to array for storage
      const pagesSet = new Set(doc.pagesRead || []);
      const wasNew = !pagesSet.has(pageNum);
      pagesSet.add(pageNum);
      doc.pagesRead = Array.from(pagesSet);
      doc.lastAccessed = new Date().toISOString();
      
      if (wasNew) {
        progress.totalPagesRead++;
        console.log(` Page ${pageNum} tracked! Total pages: ${progress.totalPagesRead}`);
        addRecentActivity('page_read', `Read page ${pageNum} in ${pdfName}`, pdfName);
      } else {
        console.log(` Page ${pageNum} already tracked`);
      }
      
      saveProgressData(progress);
      console.log(' Progress data saved:', progress);
    } catch (error) {
      console.error(' Error in trackPageRead:', error);
    }
  }
  
  function trackQuestion(question, pdfName) {
    try {
      const progress = getProgressData();
      progress.totalQuestions++;
      
      if (pdfName && progress.pdfDocuments[pdfName]) {
        progress.pdfDocuments[pdfName].questionsAsked++;
      }
      
      addRecentActivity('question', question.substring(0, 50) + '...', pdfName);
      saveProgressData(progress);
    } catch (error) {
      console.error('Error tracking question:', error);
    }
  }
  
  function addRecentActivity(type, description, context = null) {
    try {
      const progress = getProgressData();
      if (!progress.recentActivity) progress.recentActivity = [];
      
      progress.recentActivity.unshift({
        type: type,
        description: description,
        context: context,
        timestamp: new Date().toISOString()
      });
      
      // Keep only last 20 activities
      progress.recentActivity = progress.recentActivity.slice(0, 20);
      saveProgressData(progress);
    } catch (error) {
      console.error('Error adding recent activity:', error);
    }
  }
  
  function updateProgress(topic, sessionData) {
    const progress = getProgressData();
    
    // Update per-topic data
    if (!progress.topics[topic]) {
      progress.topics[topic] = {
        sessions: [],
        totalCards: 0,
        masteredCards: [],
        averageAccuracy: 0,
        lastStudied: null
      };
    }
    
    const topicData = progress.topics[topic];
    
    // Add session to history
    topicData.sessions.push({
      date: new Date().toISOString(),
      cardsStudied: sessionData.cardsStudied,
      correct: sessionData.correct,
      incorrect: sessionData.incorrect,
      accuracy: sessionData.accuracy,
      streak: sessionData.streak
    });
    
    // Update mastered cards (merge with existing, remove duplicates)
    sessionData.masteredCards.forEach(card => {
      const exists = topicData.masteredCards.some(
        c => c.front === card.front && c.back === card.back
      );
      if (!exists) {
        topicData.masteredCards.push(card);
      }
    });
    
    // Calculate total unique cards for this topic
    topicData.totalCards = Math.max(
      topicData.totalCards,
      sessionData.totalCardsInTopic
    );
    
    // Calculate average accuracy
    const totalAccuracy = topicData.sessions.reduce((sum, s) => sum + s.accuracy, 0);
    topicData.averageAccuracy = Math.round(totalAccuracy / topicData.sessions.length);
    
    topicData.lastStudied = new Date().toISOString();
    
    // Update overall stats
    progress.totalSessions++;
    progress.totalCards += sessionData.cardsStudied;
    progress.totalCorrect += sessionData.correct;
    progress.totalIncorrect += sessionData.incorrect;
    progress.bestStreak = Math.max(progress.bestStreak, sessionData.streak);
    progress.lastStudied = new Date().toISOString();
    
    // Calculate study streak (consecutive days)
    const today = new Date().toDateString();
    const lastStudiedDate = progress.lastStudied ? new Date(progress.lastStudied).toDateString() : null;
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    
    if (lastStudiedDate === yesterday) {
      progress.studyStreak++;
    } else if (lastStudiedDate !== today) {
      progress.studyStreak = 1;
    }
    
    // Add to recent activity
    addRecentActivity('flashcards', `Completed ${topic} flashcards (${sessionData.accuracy}% accuracy)`, topic);
    
    saveProgressData(progress);
    return progress;
  }
  
  function renderSidebarProgress() {
    const progress = getProgressData();
    const container = document.getElementById('progress-content');
    
    if (!container) {
      console.error('Progress content container not found');
      return;
    }
    
    console.log(' Rendering sidebar progress:', progress);
    
    const overallAccuracy = progress.totalCards > 0 
      ? Math.round((progress.totalCorrect / progress.totalCards) * 100) 
      : 0;
    
    // Calculate total time including current session
    let totalMinutes = progress.totalStudyTime || 0;
    if (progress.sessionStartTime) {
      const currentSessionMinutes = Math.floor((Date.now() - progress.sessionStartTime) / 60000);
      totalMinutes += currentSessionMinutes;
      console.log(` Total time: ${progress.totalStudyTime || 0}m saved + ${currentSessionMinutes}m current = ${totalMinutes}m`);
    }
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const timeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    
    // Build compact progress view for sidebar
    let html = `
      <div style="padding: 12px;">
        <!-- Compact Stats Grid -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
          <div style="background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3); border-radius: 6px; padding: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 2px;">${progress.totalSessions || 0}</div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px;">Sessions</div>
          </div>
          <div style="background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3); border-radius: 6px; padding: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #4ade80; margin-bottom: 2px;">${progress.totalPagesRead || 0}</div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px;">Pages</div>
          </div>
          <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 6px; padding: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #fbbf24; margin-bottom: 2px;">${progress.totalQuestions || 0}</div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px;">Questions</div>
          </div>
          <div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 6px; padding: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6; margin-bottom: 2px;">${timeDisplay}</div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px;">Time</div>
          </div>
        </div>
        
        ${(progress.studyStreak || 0) > 0 ? `
          <div style="padding: 8px; background: rgba(251,191,36,0.1); border-radius: 6px; border: 1px solid rgba(251,191,36,0.3); margin-bottom: 12px; text-align: center; font-size: 12px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
              <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
            </svg>
            <span style="color: #fbbf24; font-weight: 600;">${progress.studyStreak} day streak!</span>
          </div>
        ` : ''}
    `;
    
    // Add flashcard topics
    const topics = Object.keys(progress.topics || {});
    if (topics.length > 0) {
      html += `<div style="margin-top: 16px;">`;
      html += `<div style="font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.6); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Flashcard Topics</div>`;
      
      topics.forEach(topic => {
        const topicData = progress.topics[topic];
        const masteryPercentage = topicData.totalCards > 0
          ? Math.round((topicData.masteredCards.length / topicData.totalCards) * 100)
          : 0;
        
        html += `
          <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 10px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <span style="font-size: 12px; font-weight: 600; color: white;">${topic}</span>
              <span style="font-size: 11px; color: #667eea; font-weight: 600;">${masteryPercentage}%</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px; overflow: hidden; margin-bottom: 6px;">
              <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${masteryPercentage}%;"></div>
            </div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.5);">
              ${topicData.masteredCards.length}/${topicData.totalCards} cards  ${topicData.sessions.length} sessions
            </div>
          </div>
        `;
      });
      
      html += `</div>`;
    }
    
    // Add view full dashboard button - with proper onclick that works
    html += `
        <button id="sidebar-view-full-btn" style="width: 100%; padding: 10px; background: rgba(102,126,234,0.15); color: #667eea; border: 1px solid rgba(102,126,234,0.3); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3v18h18"/>
            <path d="m19 9-5 5-4-4-3 3"/>
          </svg>
          View Full Dashboard
        </button>
      </div>
    `;
    
    if (topics.length === 0 && (progress.totalSessions || 0) === 0 && (progress.totalPagesRead || 0) === 0 && (progress.totalQuestions || 0) === 0) {
      html = `
        <div style="padding: 40px 20px; text-align: center;">
          <div style="margin-bottom: 16px; opacity: 0.3;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 3v18h18"/>
              <path d="m19 9-5 5-4-4-3 3"/>
            </svg>
          </div>
          <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-weight: 600;">No study data yet</div>
          <div style="font-size: 11px; color: rgba(255,255,255,0.4);">
            Start studying to track your progress!
          </div>
        </div>
      `;
    }
    
    container.innerHTML = html;
    
    // Attach event listener to the button after HTML is inserted
    setTimeout(() => {
      const btn = document.getElementById('sidebar-view-full-btn');
      if (btn) {
        btn.addEventListener('click', () => {
          console.log(' Sidebar View Full button clicked');
          showProgressDashboard();
          // Switch back to chats tab to see the dashboard
          switchChunksTab('chats');
        });
      }
    }, 0);
    
    console.log(' Sidebar progress rendered');
  }
  
  function showProgressDashboard() {
    console.log(' showProgressDashboard called');
    const progress = getProgressData();
    const chat = document.getElementById('chat-messages');
    const typing = document.getElementById('typing-indicator');
    
    if (!chat || !typing) {
      console.error('Chat elements not found');
      alert('Error: Could not display progress dashboard');
      return;
    }
    
    const overallAccuracy = progress.totalCards > 0 
      ? Math.round((progress.totalCorrect / progress.totalCards) * 100) 
      : 0;
    
    // Calculate total time including current session
    let totalMinutes = progress.totalStudyTime || 0;
    if (progress.sessionStartTime) {
      const currentSessionMinutes = Math.floor((Date.now() - progress.sessionStartTime) / 60000);
      totalMinutes += currentSessionMinutes;
    }
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const timeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    
    // Flashcard topics
    let topicsHTML = '';
    Object.keys(progress.topics).forEach(topic => {
      const topicData = progress.topics[topic];
      const masteryPercentage = topicData.totalCards > 0
        ? Math.round((topicData.masteredCards.length / topicData.totalCards) * 100)
        : 0;
      
      topicsHTML += `
        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong style="font-size: 15px; color: white;">${topic}</strong>
            <span style="font-size: 13px; color: #667eea; font-weight: 600;">${masteryPercentage}% Mastered</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${masteryPercentage}%; transition: width 0.3s;"></div>
          </div>
          <div style="display: flex; gap: 16px; font-size: 13px; color: rgba(255,255,255,0.7);">
            <span>${topicData.masteredCards.length}/${topicData.totalCards} Cards</span>
            <span></span>
            <span>${topicData.sessions.length} Sessions</span>
            <span></span>
            <span>${topicData.averageAccuracy}% Avg</span>
          </div>
        </div>
      `;
    });
    
    if (Object.keys(progress.topics).length === 0) {
      topicsHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">No flashcard data yet.</p>';
    }
    
    // PDF documents
    let pdfsHTML = '';
    Object.keys(progress.pdfDocuments).forEach(pdfName => {
      const doc = progress.pdfDocuments[pdfName];
      const pagesRead = (doc.pagesRead || []).length;  // Already an array
      const coverage = doc.totalPages > 0 ? Math.round((pagesRead / doc.totalPages) * 100) : 0;
      
      pdfsHTML += `
        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong style="font-size: 15px; color: white;">${pdfName}</strong>
            <span style="font-size: 13px; color: #4ade80; font-weight: 600;">${coverage}% Read</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
            <div style="background: linear-gradient(90deg, #4ade80, #22c55e); height: 100%; width: ${coverage}%; transition: width 0.3s;"></div>
          </div>
          <div style="display: flex; gap: 16px; font-size: 13px; color: rgba(255,255,255,0.7);">
            <span>${pagesRead} Pages Read</span>
            <span></span>
            <span>${doc.questionsAsked} Questions</span>
          </div>
        </div>
      `;
    });
    
    if (Object.keys(progress.pdfDocuments).length === 0) {
      pdfsHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">No PDF data yet. Upload a document to start!</p>';
    }
    
    // Recent activity
    let activityHTML = '';
    if (progress.recentActivity && progress.recentActivity.length > 0) {
      progress.recentActivity.slice(0, 10).forEach(activity => {
        const date = new Date(activity.timestamp);
        const timeAgo = getTimeAgo(date);
        
        let icon = '';
        let color = '';
        if (activity.type === 'flashcards') {
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/></svg>';
          color = '#667eea';
        } else if (activity.type === 'page_read') {
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>';
          color = '#4ade80';
        } else if (activity.type === 'question') {
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>';
          color = '#fbbf24';
        }
        
        activityHTML += `
          <div style="display: flex; gap: 12px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 8px;">
            <div style="flex-shrink: 0; margin-top: 2px;">${icon}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 13px; color: white; margin-bottom: 2px;">${activity.description}</div>
              <div style="font-size: 11px; color: rgba(255,255,255,0.5);">${timeAgo}</div>
            </div>
          </div>
        `;
      });
    } else {
      activityHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">No recent activity.</p>';
    }
    
    const container = document.createElement('div');
    container.className = 'message ai';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    
    bubble.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 3v18h18"/>
          <path d="m19 9-5 5-4-4-3 3"/>
        </svg>
        <strong style="font-size: 18px;">Your Progress</strong>
      </div>
      
      <!-- Overall Stats -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <div style="padding: 16px; background: rgba(102,126,234,0.1); border-radius: 8px; border: 1px solid rgba(102,126,234,0.3); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 4px;">${progress.totalSessions}</div>
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase;">Flashcard<br>Sessions</div>
        </div>
        <div style="padding: 16px; background: rgba(74,222,128,0.1); border-radius: 8px; border: 1px solid rgba(74,222,128,0.3); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #4ade80; margin-bottom: 4px;">${progress.totalPagesRead}</div>
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase;">Pages<br>Read</div>
        </div>
        <div style="padding: 16px; background: rgba(251,191,36,0.1); border-radius: 8px; border: 1px solid rgba(251,191,36,0.3); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #fbbf24; margin-bottom: 4px;">${progress.totalQuestions}</div>
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase;">Questions<br>Asked</div>
        </div>
        <div style="padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px; border: 1px solid rgba(139,92,246,0.3); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: #8b5cf6; margin-bottom: 4px;">${timeDisplay}</div>
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase;">Study<br>Time</div>
        </div>
      </div>
      
      ${progress.studyStreak > 0 ? `
        <div style="padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px; border: 1px solid rgba(251,191,36,0.3); margin-bottom: 20px; text-align: center;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
          </svg>
          <span style="color: #fbbf24; font-weight: 600; font-size: 14px;">
            ${progress.studyStreak} day${progress.studyStreak > 1 ? 's' : ''} study streak! 
          </span>
        </div>
      ` : ''}
      
      <!-- Recent Activity -->
      <div style="margin-top: 20px; margin-bottom: 20px;">
        <h3 style="font-size: 16px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">Recent Activity</h3>
        <div style="max-height: 300px; overflow-y: auto;">
          ${activityHTML}
        </div>
      </div>
      
      <!-- PDF Documents -->
      <div style="margin-top: 20px;">
        <h3 style="font-size: 16px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">Documents</h3>
        ${pdfsHTML}
      </div>
      
      <!-- Flashcard Topics -->
      <div style="margin-top: 20px;">
        <h3 style="font-size: 16px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 600;">Flashcard Topics</h3>
        ${topicsHTML}
      </div>
      
      <p style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 16px; text-align: center;">
        Keep studying to improve your stats! 
      </p>
    `;
    
    container.appendChild(bubble);
    chat.insertBefore(container, typing);
    chat.scrollTop = chat.scrollHeight;
  }
  
  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
    return date.toLocaleDateString();
  }

  function displayFlashcardsInChat(flashcards, topic) {
    const chat = document.getElementById('chat-messages');
    const typing = document.getElementById('typing-indicator');
    const container = document.createElement('div');
    container.className = 'message ai';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble flashcard-bubble';
    const timestamp = Date.now();
    
    // Initialize study session
    let currentCard = 0;
    let correct = 0;
    let incorrect = 0;
    let streak = 0;
    let maxStreak = 0;
    let isFlipped = false;
    let knownCards = []; // Track cards marked as "I Know This"
    let activeFlashcards = [...flashcards]; // Working copy of flashcards
    
    function updateDisplay() {
      if (currentCard >= activeFlashcards.length) {
        showComplete();
        return;
      }
      
      const card = activeFlashcards[currentCard];
      const progress = ((currentCard) / activeFlashcards.length) * 100;
      isFlipped = false; // Reset flip state for new card
      
      bubble.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
          </svg>
          <strong style="font-size: 16px;">Studying: ${topic}</strong>
        </div>
        
        <!-- Progress & Stats -->
        <div class="flashcard-controls">
          <div class="flashcard-progress">
            <div class="progress-text">
              <span>Card ${currentCard + 1} of ${activeFlashcards.length}</span>
              <span>${Math.round(progress)}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
          </div>
          <div class="flashcard-stats">
            <div class="stat stat-correct">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 6 9 17l-5-5"/>
              </svg>
              ${correct}
            </div>
            <div class="stat stat-incorrect">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"/>
                <path d="m6 6 12 12"/>
              </svg>
              ${incorrect}
            </div>
            <div class="stat stat-streak">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
              </svg>
              ${streak}
            </div>
          </div>
        </div>
        
        <!-- Flashcard -->
        <div class="mini-flashcards">
          <div class="mini-card" id="flashcard-${timestamp}">
            <div class="mini-card-inner" id="flashcard-inner-${timestamp}">
              <div class="mini-card-front">
                <div class="card-label">Question</div>
                <div class="card-content">${card.front}</div>
              </div>
              <div class="mini-card-back">
                <div class="card-label">Answer</div>
                <div class="card-content">${card.back}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="flashcard-actions" id="flashcard-actions-${timestamp}">
          <button class="flashcard-btn btn-flip" id="flip-btn-${timestamp}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Flip Card
          </button>
          <button class="flashcard-btn btn-know" id="know-btn-${timestamp}" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <path d="m9 11 3 3L22 4"/>
            </svg>
            I Know This
          </button>
          <button class="flashcard-btn btn-dont-know" id="dontknow-btn-${timestamp}" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="m15 9-6 6"/>
              <path d="m9 9 6 6"/>
            </svg>
            Need Review
          </button>
        </div>
      `;
      
      // Attach event listeners after DOM is updated
      setTimeout(() => {
        const flipBtn = document.getElementById(`flip-btn-${timestamp}`);
        const knowBtn = document.getElementById(`know-btn-${timestamp}`);
        const dontKnowBtn = document.getElementById(`dontknow-btn-${timestamp}`);
        
        if (flipBtn) {
          flipBtn.addEventListener('click', () => {
            const card = document.getElementById(`flashcard-${timestamp}`);
            if (card) {
              isFlipped = !isFlipped;
              if (isFlipped) {
                card.classList.add('flipped');
                if (knowBtn) knowBtn.style.display = 'flex';
                if (dontKnowBtn) dontKnowBtn.style.display = 'flex';
              } else {
                card.classList.remove('flipped');
                if (knowBtn) knowBtn.style.display = 'none';
                if (dontKnowBtn) dontKnowBtn.style.display = 'none';
              }
            }
          });
        }
        
        if (knowBtn) {
          knowBtn.addEventListener('click', () => {
            // Track this card as known
            knownCards.push(activeFlashcards[currentCard]);
            correct++;
            streak++;
            if (streak > maxStreak) maxStreak = streak;
            currentCard++;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        if (dontKnowBtn) {
          dontKnowBtn.addEventListener('click', () => {
            incorrect++;
            streak = 0;
            currentCard++;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        renderMath(bubble);
      }, 0);
    }
    
    function showComplete() {
      const accuracy = activeFlashcards.length > 0 ? Math.round((correct / activeFlashcards.length) * 100) : 0;
      
      // Save progress data
      updateProgress(topic, {
        cardsStudied: activeFlashcards.length,
        correct: correct,
        incorrect: incorrect,
        accuracy: accuracy,
        streak: maxStreak,
        masteredCards: knownCards,
        totalCardsInTopic: flashcards.length
      });
      
      // Choose icon and message based on accuracy
      let icon, message;
      if (accuracy >= 80) {
        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"/></svg>';
        message = 'Excellent work! You\'ve mastered this topic!';
      } else if (accuracy >= 60) {
        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg>';
        message = 'Good progress! Review the cards you missed.';
      } else {
        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12h12"/><path d="M6 12c0 1-1 2-2 2s-2-1-2-2 1-2 2-2 2 1 2 2Z"/><path d="M18 12c0 1 1 2 2 2s2-1 2-2-1-2-2-2-2 1-2 2Z"/><path d="M6 12v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5"/><path d="M10 9V7a2 2 0 1 1 4 0v2"/></svg>';
        message = 'Keep practicing! You\'re on your way to mastery.';
      }
      
      bubble.innerHTML = `
        <div class="flashcard-complete">
          <div class="complete-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
              <path d="m11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"/>
            </svg>
            Study Session Complete!
          </div>
          <div class="complete-stats">
            <div class="complete-stat">
              <div class="complete-stat-value" style="color: #667eea;">${flashcards.length}</div>
              <div class="complete-stat-label">Cards Studied</div>
            </div>
            <div class="complete-stat">
              <div class="complete-stat-value" style="color: #4ade80;">${correct}</div>
              <div class="complete-stat-label">Correct</div>
            </div>
            <div class="complete-stat">
              <div class="complete-stat-value" style="color: #f87171;">${incorrect}</div>
              <div class="complete-stat-label">Need Review</div>
            </div>
            <div class="complete-stat">
              <div class="complete-stat-value" style="color: #fbbf24;">${maxStreak}</div>
              <div class="complete-stat-label">Best Streak</div>
            </div>
            <div class="complete-stat">
              <div class="complete-stat-value" style="color: #667eea;">${accuracy}%</div>
              <div class="complete-stat-label">Accuracy</div>
            </div>
          </div>
          <p style="color: rgba(255,255,255,0.6); margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            ${icon} ${message}
          </p>
          ${knownCards.length > 0 ? `
          <div style="margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);">
            <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 8px; text-align: center;">
               Card Status
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; align-items: center;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <path d="m9 11 3 3L22 4"/>
                </svg>
                <span style="color: #4ade80; font-weight: 600;">${knownCards.length} Mastered</span>
              </div>
              <div style="color: rgba(255,255,255,0.3);">|</div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 8v4"/>
                  <path d="M12 16h.01"/>
                </svg>
                <span style="color: #f87171; font-weight: 600;">${flashcards.length - knownCards.length} To Review</span>
              </div>
            </div>
          </div>
          ` : ''}
          
          <!-- Retry Actions -->
          <div class="flashcard-actions" style="margin-top: 24px; flex-wrap: wrap;">
            ${knownCards.length > 0 && knownCards.length < flashcards.length ? `
              <button class="flashcard-btn btn-know" id="retry-wrong-btn-${timestamp}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                </svg>
                Retry Wrong Cards (${flashcards.length - knownCards.length})
              </button>
              <button class="flashcard-btn" id="shuffle-wrong-btn-${timestamp}" style="background: rgba(102,126,234,0.15); color: #667eea; border: 1px solid rgba(102,126,234,0.3);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m18 14 4 4-4 4"/>
                  <path d="m18 2 4 4-4 4"/>
                  <path d="M2 18h1.973a4 4 0 0 0 2.483-.874l8.272-6.252a4 4 0 0 1 2.483-.874H22"/>
                  <path d="M2 6h1.973a4 4 0 0 1 2.483.874l8.272 6.252a4 4 0 0 0 2.483.874H22"/>
                </svg>
                Shuffle Wrong Cards
              </button>
            ` : `
              <button class="flashcard-btn btn-know" id="retry-btn-${timestamp}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                </svg>
                Try Again
              </button>
              <button class="flashcard-btn" id="shuffle-btn-${timestamp}" style="background: rgba(102,126,234,0.15); color: #667eea; border: 1px solid rgba(102,126,234,0.3);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m18 14 4 4-4 4"/>
                  <path d="m18 2 4 4-4 4"/>
                  <path d="M2 18h1.973a4 4 0 0 0 2.483-.874l8.272-6.252a4 4 0 0 1 2.483-.874H22"/>
                  <path d="M2 6h1.973a4 4 0 0 1 2.483.874l8.272 6.252a4 4 0 0 0 2.483.874H22"/>
                </svg>
                Shuffle & Retry
              </button>
            `}
            ${knownCards.length > 0 && knownCards.length < flashcards.length ? `
              <button class="flashcard-btn btn-flip" id="retry-all-btn-${timestamp}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/>
                  <path d="m6.08 9.5-3.5 1.6a1 1 0 0 0 0 1.81l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9a1 1 0 0 0 0-1.83l-3.5-1.59"/>
                  <path d="m6.08 14.5-3.5 1.6a1 1 0 0 0 0 1.81l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9a1 1 0 0 0 0-1.83l-3.5-1.59"/>
                </svg>
                Retry All Cards (${flashcards.length})
              </button>
            ` : ''}
          </div>
          
          <!-- View Progress Button -->
          <div style="margin-top: 16px; text-align: center;">
            <button class="flashcard-btn" id="view-progress-btn-${timestamp}" style="background: rgba(139,92,246,0.15); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.3);">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3v18h18"/>
                <path d="m19 9-5 5-4-4-3 3"/>
              </svg>
              View My Progress
            </button>
          </div>
        </div>
      `;
      
      // Attach retry button listeners
      setTimeout(() => {
        const retryWrongBtn = document.getElementById(`retry-wrong-btn-${timestamp}`);
        const shuffleWrongBtn = document.getElementById(`shuffle-wrong-btn-${timestamp}`);
        const retryAllBtn = document.getElementById(`retry-all-btn-${timestamp}`);
        const retryBtn = document.getElementById(`retry-btn-${timestamp}`);
        const shuffleBtn = document.getElementById(`shuffle-btn-${timestamp}`);
        
        // Retry wrong cards only (keep same order)
        if (retryWrongBtn) {
          retryWrongBtn.addEventListener('click', () => {
            // Filter out known cards
            activeFlashcards = flashcards.filter(card => !knownCards.includes(card));
            currentCard = 0;
            correct = 0;
            incorrect = 0;
            streak = 0;
            maxStreak = 0;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        // Shuffle wrong cards only
        if (shuffleWrongBtn) {
          shuffleWrongBtn.addEventListener('click', () => {
            // Filter out known cards
            activeFlashcards = flashcards.filter(card => !knownCards.includes(card));
            // Shuffle
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            currentCard = 0;
            correct = 0;
            incorrect = 0;
            streak = 0;
            maxStreak = 0;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        // Retry all cards (reset everything)
        if (retryAllBtn) {
          retryAllBtn.addEventListener('click', () => {
            activeFlashcards = [...flashcards];
            knownCards = [];
            currentCard = 0;
            correct = 0;
            incorrect = 0;
            streak = 0;
            maxStreak = 0;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        // Regular retry (all cards, no filtering - for when no cards are marked as known yet)
        if (retryBtn) {
          retryBtn.addEventListener('click', () => {
            activeFlashcards = [...flashcards];
            currentCard = 0;
            correct = 0;
            incorrect = 0;
            streak = 0;
            maxStreak = 0;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        // Regular shuffle (all cards)
        if (shuffleBtn) {
          shuffleBtn.addEventListener('click', () => {
            activeFlashcards = [...flashcards];
            for (let i = activeFlashcards.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
            }
            currentCard = 0;
            correct = 0;
            incorrect = 0;
            streak = 0;
            maxStreak = 0;
            updateDisplay();
            saveChatHistory();
          });
        }
        
        // View Progress button
        const viewProgressBtn = document.getElementById(`view-progress-btn-${timestamp}`);
        if (viewProgressBtn) {
          viewProgressBtn.addEventListener('click', () => {
            console.log(' View Progress button clicked');
            showProgressDashboard();
          });
        } else {
          console.error(' View Progress button not found');
        }
      }, 0);
    }
    
    container.appendChild(bubble);
    chat.insertBefore(container, typing);
    chat.scrollTop = chat.scrollHeight;
    updateDisplay();
    saveChatHistory();
  }

  function flipMiniCard(id) {
    const card = document.getElementById(`mini-card-${id}`);
    if (card) card.classList.toggle('flipped');
  }

  function addChatMessage(text, sender, source = null) {
    const chat = document.getElementById('chat-messages');
    const typing = document.getElementById('typing-indicator');
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    if (sender === 'user') {
      bubble.textContent = text;
    } else {
      const formattedText = formatAIResponse(text);
      bubble.innerHTML = formattedText;
      if (source && source.page) {
        const ref = document.createElement('div');
        ref.className = 'page-reference';
        ref.innerHTML = `<svg class="icon" width="18" height="18"><use href="#icon-document"/></svg> See Page ${source.page}`;
        ref.onclick = () => jumpToPage(source.page);
        bubble.appendChild(ref);
      }
      if (source) {
        const footer = document.createElement('div');
        footer.className = 'source-footer';
        footer.innerHTML = `<svg class="icon" width="18" height="18"><use href="#icon-books"/></svg> ${source.textbook || 'Textbook'}  ${source.chapter || 'Chapter N/A'}`;
        bubble.appendChild(footer);
      }
      setTimeout(() => {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
          MathJax.typesetPromise([bubble]).catch(err => console.log('MathJax error:', err));
        }
      }, 100);
    }
    div.appendChild(bubble);
    chat.insertBefore(div, typing);
    chat.scrollTop = chat.scrollHeight;
    
    // Auto-limit messages to prevent overflow (keep last 50 messages)
    limitChatMessages();
    
    saveChatHistory();
  }

  function formatAIResponse(text) {
    if (!text || typeof text !== "string") {
      return " AI returned no response.";
    }

    text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.+)$/gm, '<h3>$1</h3>');
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/^[\-\*] /gm, ' ');
    text = text.replace(/\n/g, '<br>');
    return text;
  }

  function clearChat() {
    // Confirm before clearing
    if (confirm('Clear all chat messages? This cannot be undone.')) {
      const chat = document.getElementById('chat-messages');
      const typing = document.getElementById('typing-indicator');
      
      // Remove all messages except typing indicator
      const messages = chat.querySelectorAll('.message');
      messages.forEach(msg => msg.remove());
      
      // Add welcome message
      addChatMessage('Chat cleared! Ask me anything about your textbook.', 'ai');
      
      console.log(' Chat cleared');
    }
  }

  function limitChatMessages(maxMessages = 50) {
    const chat = document.getElementById('chat-messages');
    const messages = chat.querySelectorAll('.message');
    
    // If more than maxMessages, remove oldest ones
    if (messages.length > maxMessages) {
      const toRemove = messages.length - maxMessages;
      for (let i = 0; i < toRemove; i++) {
        messages[i].remove();
      }
      console.log(` Removed ${toRemove} old messages (keeping last ${maxMessages})`);
    }
  }

  let currentZoom = 1.5;

  function zoomIn() {
    if (currentZoom >= 3) return;
    currentZoom += 0.25;
    scale = currentZoom;
    document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
    reRenderAllPages();
  }

  function zoomOut() {
    if (currentZoom <= 0.5) return;
    currentZoom -= 0.25;
    scale = currentZoom;
    document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
    reRenderAllPages();
  }

  function fitToWidth() {
    const viewer = document.getElementById('pdf-viewer');
    const viewerWidth = viewer.clientWidth - 40;
    if (pdfDoc) {
      pdfDoc.getPage(1).then(page => {
        const viewport = page.getViewport({ scale: 1 });
        currentZoom = viewerWidth / viewport.width;
        scale = currentZoom;
        document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
        reRenderAllPages();
      });
    }
  }

  async function reRenderAllPages() {
    if (!pdfDoc) return;
    const container = document.getElementById('pdf-pages-container');
    if (!container) return;
    container.innerHTML = '';
    renderedPages.clear();
    for (let i = 1; i <= Math.min(3, pdfDoc.numPages); i++) {
      await renderPageScroll(i);
    }
  }

  function previousPageScroll() {
    if (currentPage > 1) {
      jumpToPage(currentPage - 1);
    }
  }

  function nextPageScroll() {
    if (currentPage < pdfDoc.numPages) {
      jumpToPage(currentPage + 1);
    }
  }

  function goToPageInput() {
    const input = document.getElementById('page-input');
    const pageNumber = parseInt(input.value);
    if (!pdfDoc) {
      alert('Please select a book from the library first!');
      input.value = currentPage;
      return;
    }
    if (pageNumber >= 1 && pageNumber <= pdfDoc.numPages) {
      jumpToPage(pageNumber);
      input.blur();
    } else {
      alert(`Please enter a page between 1 and ${pdfDoc.numPages}`);
      input.value = currentPage;
    }
  }

  function searchPDF() {
    const overlay = document.getElementById('search-overlay');
    overlay.classList.toggle('active');
    if (overlay.classList.contains('active')) {
      document.getElementById('search-input').focus();
    }
  }

  function handleSearch(event) {
    const searchTerm = event.target.value.toLowerCase();
    const results = document.getElementById('search-results');
    if (searchTerm.length < 2) {
      results.textContent = '';
      return;
    }
    let foundCount = 0;
    outlineData.forEach(item => {
      if (item.title.toLowerCase().includes(searchTerm)) {
        foundCount++;
      }
    });
    results.textContent = foundCount > 0 ? `${foundCount} results found in outline` : 'No results';
  }

  function printPDF() {
    if (!pdfDoc) {
      alert('Please select a book from the library first!');
      return;
    }
    window.print();
  }

  function downloadPDF() {
    const savedPDF = localStorage.getItem('eightysix_pdf_data');
    const savedName = localStorage.getItem('eightysix_pdf_name');
    if (!savedPDF) {
      alert('No PDF loaded!');
      return;
    }
    const link = document.createElement('a');
    link.href = savedPDF;
    link.download = savedName || 'textbook.pdf';
    link.click();
  }

  function updatePageInput() {
    const input = document.getElementById('page-input');
    const total = document.getElementById('page-total');
    if (input) input.value = currentPage;
    if (total && pdfDoc) total.textContent = pdfDoc.numPages;
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= pdfDoc.numPages;
  }

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      searchPDF();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
      e.preventDefault();
      printPDF();
    }
    if (!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
      if (e.key === 'ArrowLeft') {
        previousPageScroll();
      } else if (e.key === 'ArrowRight') {
        nextPageScroll();
      }
    }
    if (e.key === '+' || e.key === '=') {
      e.preventDefault();
      zoomIn();
    } else if (e.key === '-') {
      e.preventDefault();
      zoomOut();
    }
  });

  // CHAT HISTORY MANAGEMENT
  let currentChatId = null;
  let chatSessions = {};

  window.addEventListener('load', () => {
    loadChatSessions();
    displayChatHistory();
    if (Object.keys(chatSessions).length === 0) {
      createNewChat();
    } else {
      const chatIds = Object.keys(chatSessions).sort((a, b) => chatSessions[b].timestamp - chatSessions[a].timestamp);
      loadChat(chatIds[0]);
    }
  });

  function toggleChatHistory() {
    document.getElementById('chat-history-sidebar').classList.toggle('open');
  }

  function createNewChat() {
    if (currentChatId) {
      saveCurrentChat();
    }
    const chatId = 'chat_' + Date.now();
    currentChatId = chatId;
    chatSessions[chatId] = {
      id: chatId,
      title: 'New Chat',
      messages: [],
      timestamp: Date.now(),
      mode: 'study'
    };
    const chat = document.getElementById('chat-messages');
    const typing = document.getElementById('typing-indicator');
    chat.innerHTML = '';
    chat.appendChild(typing);
    addChatMessage('<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;"><path d="M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2"/><path d="M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>Welcome to Chunks! Select a book from the library and ask questions.', 'ai');
    saveChatSessions();
    displayChatHistory();
    if (window.innerWidth < 768) {
      toggleChatHistory();
    }
    console.log(' Created new chat:', chatId);
  }

  function loadChat(chatId) {
    if (currentChatId && currentChatId !== chatId) {
      saveCurrentChat();
    }
    currentChatId = chatId;
    const session = chatSessions[chatId];
    if (!session) {
      console.error('Chat not found:', chatId);
      return;
    }
    const chat = document.getElementById('chat-messages');
    const typing = document.getElementById('typing-indicator');
    chat.innerHTML = '';
    chat.appendChild(typing);
    session.messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = `message ${msg.sender}`;
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = msg.html;
      const pageRefs = bubble.querySelectorAll('.page-reference');
      pageRefs.forEach(ref => {
        const pageMatch = ref.textContent.match(/\d+/);
        if (pageMatch) {
          ref.onclick = () => jumpToPage(parseInt(pageMatch[0]));
        }
      });
      const flashcards = bubble.querySelectorAll('.mini-card');
      flashcards.forEach(card => {
        const id = card.id;
        if (id) {
          card.onclick = () => flipMiniCard(id.replace('mini-card-', ''));
        }
      });
      div.appendChild(bubble);
      chat.insertBefore(div, typing);
    });
    if (session.mode) {
      setMode(session.mode);
    }
    chat.scrollTop = chat.scrollHeight;
    if (typeof MathJax !== 'undefined') {
      setTimeout(() => renderMath(chat), 100);
    }
    displayChatHistory();
    if (window.innerWidth < 768) {
      toggleChatHistory();
    }
    console.log(' Loaded chat:', chatId, '- Messages:', session.messages.length);
  }

  function saveCurrentChat() {
    if (!currentChatId) return;
    const session = chatSessions[currentChatId];
    if (!session) return;
    const messages = [];
    document.querySelectorAll('.message').forEach(msg => {
      if (!msg.querySelector('.typing-indicator')) {
        const bubble = msg.querySelector('.message-bubble');
        messages.push({
          sender: msg.classList.contains('user') ? 'user' : 'ai',
          html: bubble ? bubble.innerHTML : msg.innerHTML
        });
      }
    });
    session.messages = messages;
    session.timestamp = Date.now();
    if (messages.length > 0 && session.title === 'New Chat') {
      const firstUserMsg = messages.find(m => m.sender === 'user');
      if (firstUserMsg) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = firstUserMsg.html;
        const text = tempDiv.textContent || tempDiv.innerText;
        session.title = text.substring(0, 40) + (text.length > 40 ? '...' : '');
      }
    }
    session.mode = currentStudyMode;
    saveChatSessions();
    displayChatHistory();
  }

  function deleteChat(chatId, event) {
    event.stopPropagation();
    if (!confirm('Delete this chat?')) return;
    delete chatSessions[chatId];
    saveChatSessions();
    displayChatHistory();
    if (currentChatId === chatId) {
      createNewChat();
    }
    console.log('<svg class="icon" width="16" height="16"><use href="#icon-trash"/></svg> Deleted chat:', chatId);
  }

function displayChatHistory() {
  const list = document.getElementById('chat-history-list');
  const chatIds = Object.keys(chatSessions).sort((a, b) => 
    chatSessions[b].timestamp - chatSessions[a].timestamp
  );
  
  if (chatIds.length === 0) {
    list.innerHTML = `
      <div class="chat-history-empty">
        <div class="chunks-empty-icon"><svg class="icon" width="18" height="18"><use href="#icon-chat"/></svg></div>
        <div class="chunks-empty-text">No chats yet<br>Start a new conversation!</div>
      </div>
    `;
    return;
  }
  
  list.innerHTML = chatIds.map(chatId => {
    const session = chatSessions[chatId];
    
    let preview = 'Empty chat';
    if (session.messages.length > 0) {
      const firstMsg = session.messages[0];
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = firstMsg.html;
      const text = tempDiv.textContent || tempDiv.innerText;
      preview = text.substring(0, 50) + (text.length > 50 ? '...' : '');
    }
    
    const time = formatTimestamp(session.timestamp);
    const isActive = chatId === currentChatId ? 'active' : '';
    
    return `
      <div class="chat-history-item ${isActive}" onclick="loadChat('${chatId}')">
        <div class="chat-history-title">${escapeHtml(session.title)}</div>
        <div class="chat-history-preview">${escapeHtml(preview)}</div>
        <div class="chat-history-time">${time}</div>
        <button class="chat-history-delete" onclick="event.stopPropagation(); deleteChat('${chatId}', event)" title="Delete"><svg class="icon" width="16" height="16"><use href="#icon-trash"/></svg></button>
      </div>
    `;
  }).join('');
}

  function formatTimestamp(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    const date = new Date(timestamp);
    return date.toLocaleDateString();
  }

  function saveChatSessions() {
    localStorage.setItem('eightysix_chat_sessions', JSON.stringify(chatSessions));
  }

  function loadChatSessions() {
    const saved = localStorage.getItem('eightysix_chat_sessions');
    if (saved) {
      try {
        chatSessions = JSON.parse(saved);
        console.log(' Loaded', Object.keys(chatSessions).length, 'chat sessions');
      } catch (e) {
        console.error('Error loading chat sessions:', e);
        chatSessions = {};
      }
    }
  }

  setInterval(() => {
    if (currentChatId) {
      saveCurrentChat();
    }
  }, 30000);

// 3D MOLECULE VIEWER
let modalViewer = null;
let currentModalStyle = 'stick';
let activeBubbles = [];

function createMoleculeBubble(moleculeName, index = 0) {
    const container = document.getElementById('molecule-bubbles-container');
    
    if (document.querySelector(`[data-molecule="${moleculeName}"]`)) {
        console.log(`Bubble for ${moleculeName} already exists`);
        return;
    }
    
    const bubble = document.createElement('div');
    bubble.className = 'molecule-bubble';
    bubble.setAttribute('data-molecule', moleculeName);
    
    const positions = [
        { right: '30px', top: '20%' },
        { right: '30px', top: '40%' },
        { right: '30px', top: '60%' },
    ];
    
    const pos = positions[index % positions.length];
    bubble.style.right = pos.right;
    bubble.style.top = pos.top;
    
    // Real molecular structures as SVG
    const moleculeStructures = {
        'water': `
            <svg viewBox="0 0 80 60" width="50" height="40">
                <defs>
                    <radialGradient id="oxygen">
                        <stop offset="0%" style="stop-color:#ff4444"/>
                        <stop offset="100%" style="stop-color:#cc0000"/>
                    </radialGradient>
                    <radialGradient id="hydrogen">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#cccccc"/>
                    </radialGradient>
                </defs>
                <!-- Oxygen atom (center, red) -->
                <circle cx="40" cy="30" r="12" fill="url(#oxygen)"/>
                <!-- Hydrogen atoms (white) -->
                <circle cx="20" cy="45" r="8" fill="url(#hydrogen)"/>
                <circle cx="60" cy="45" r="8" fill="url(#hydrogen)"/>
                <!-- Bonds -->
                <line x1="28" y1="38" x2="24" y2="42" stroke="#fff" stroke-width="2"/>
                <line x1="52" y1="38" x2="56" y2="42" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'oxygen': `
            <svg viewBox="0 0 80 40" width="50" height="30">
                <defs>
                    <radialGradient id="o2">
                        <stop offset="0%" style="stop-color:#ff6666"/>
                        <stop offset="100%" style="stop-color:#dd0000"/>
                    </radialGradient>
                </defs>
                <!-- O=O double bond -->
                <circle cx="25" cy="20" r="10" fill="url(#o2)"/>
                <circle cx="55" cy="20" r="10" fill="url(#o2)"/>
                <line x1="35" y1="18" x2="45" y2="18" stroke="#fff" stroke-width="2"/>
                <line x1="35" y1="22" x2="45" y2="22" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'hydrogen': `
            <svg viewBox="0 0 80 40" width="50" height="30">
                <defs>
                    <radialGradient id="h2">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#aaaaaa"/>
                    </radialGradient>
                </defs>
                <!-- H-H single bond -->
                <circle cx="25" cy="20" r="10" fill="url(#h2)"/>
                <circle cx="55" cy="20" r="10" fill="url(#h2)"/>
                <line x1="35" y1="20" x2="45" y2="20" stroke="#ccc" stroke-width="2"/>
            </svg>`,
        'carbon dioxide': `
            <svg viewBox="0 0 100 40" width="60" height="30">
                <defs>
                    <radialGradient id="carbonGrad">
                        <stop offset="0%" style="stop-color:#666666"/>
                        <stop offset="100%" style="stop-color:#333333"/>
                    </radialGradient>
                    <radialGradient id="oxygenGrad">
                        <stop offset="0%" style="stop-color:#ff4444"/>
                        <stop offset="100%" style="stop-color:#cc0000"/>
                    </radialGradient>
                </defs>
                <!-- O=C=O linear -->
                <circle cx="20" cy="20" r="9" fill="url(#oxygenGrad)"/>
                <circle cx="50" cy="20" r="11" fill="url(#carbonGrad)"/>
                <circle cx="80" cy="20" r="9" fill="url(#oxygenGrad)"/>
                <!-- Double bonds -->
                <line x1="29" y1="18" x2="41" y2="18" stroke="#fff" stroke-width="2"/>
                <line x1="29" y1="22" x2="41" y2="22" stroke="#fff" stroke-width="2"/>
                <line x1="59" y1="18" x2="71" y2="18" stroke="#fff" stroke-width="2"/>
                <line x1="59" y1="22" x2="71" y2="22" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'glucose': `
            <svg viewBox="0 0 80 80" width="50" height="50">
                <defs>
                    <radialGradient id="glucoseC">
                        <stop offset="0%" style="stop-color:#555555"/>
                        <stop offset="100%" style="stop-color:#222222"/>
                    </radialGradient>
                    <radialGradient id="glucoseO">
                        <stop offset="0%" style="stop-color:#ff5555"/>
                        <stop offset="100%" style="stop-color:#dd0000"/>
                    </radialGradient>
                </defs>
                <!-- Simplified glucose ring (hexagon) -->
                <circle cx="40" cy="20" r="7" fill="url(#glucoseC)"/>
                <circle cx="60" cy="35" r="7" fill="url(#glucoseC)"/>
                <circle cx="55" cy="60" r="7" fill="url(#glucoseC)"/>
                <circle cx="25" cy="60" r="7" fill="url(#glucoseC)"/>
                <circle cx="20" cy="35" r="7" fill="url(#glucoseC)"/>
                <circle cx="40" cy="50" r="6" fill="url(#glucoseO)"/>
                <!-- Bonds -->
                <line x1="45" y1="24" x2="56" y2="31" stroke="#fff" stroke-width="2"/>
                <line x1="59" y1="42" x2="56" y2="53" stroke="#fff" stroke-width="2"/>
                <line x1="48" y1="60" x2="32" y2="60" stroke="#fff" stroke-width="2"/>
                <line x1="24" y1="53" x2="22" y2="42" stroke="#fff" stroke-width="2"/>
                <line x1="25" y1="30" x2="36" y2="24" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'ethanol': `
            <svg viewBox="0 0 80 50" width="55" height="35">
                <defs>
                    <radialGradient id="ethanolC">
                        <stop offset="0%" style="stop-color:#666666"/>
                        <stop offset="100%" style="stop-color:#333333"/>
                    </radialGradient>
                    <radialGradient id="ethanolO">
                        <stop offset="0%" style="stop-color:#ff4444"/>
                        <stop offset="100%" style="stop-color:#cc0000"/>
                    </radialGradient>
                    <radialGradient id="ethanolH">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#cccccc"/>
                    </radialGradient>
                </defs>
                <!-- C-C-OH structure -->
                <circle cx="20" cy="25" r="9" fill="url(#ethanolC)"/>
                <circle cx="45" cy="25" r="9" fill="url(#ethanolC)"/>
                <circle cx="65" cy="25" r="8" fill="url(#ethanolO)"/>
                <circle cx="75" cy="15" r="6" fill="url(#ethanolH)"/>
                <!-- Bonds -->
                <line x1="29" y1="25" x2="36" y2="25" stroke="#fff" stroke-width="2"/>
                <line x1="54" y1="25" x2="57" y2="25" stroke="#fff" stroke-width="2"/>
                <line x1="68" y1="20" x2="73" y2="17" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'benzene': `
            <svg viewBox="0 0 80 80" width="50" height="50">
                <defs>
                    <radialGradient id="benzeneC">
                        <stop offset="0%" style="stop-color:#555555"/>
                        <stop offset="100%" style="stop-color:#222222"/>
                    </radialGradient>
                </defs>
                <!-- Hexagonal ring -->
                <circle cx="40" cy="15" r="7" fill="url(#benzeneC)"/>
                <circle cx="60" cy="30" r="7" fill="url(#benzeneC)"/>
                <circle cx="60" cy="50" r="7" fill="url(#benzeneC)"/>
                <circle cx="40" cy="65" r="7" fill="url(#benzeneC)"/>
                <circle cx="20" cy="50" r="7" fill="url(#benzeneC)"/>
                <circle cx="20" cy="30" r="7" fill="url(#benzeneC)"/>
                <!-- Alternating double bonds -->
                <line x1="45" y1="18" x2="56" y2="27" stroke="#fff" stroke-width="2.5"/>
                <line x1="60" y1="37" x2="60" y2="43" stroke="#fff" stroke-width="2"/>
                <line x1="56" y1="53" x2="45" y2="62" stroke="#fff" stroke-width="2.5"/>
                <line x1="33" y1="62" x2="24" y2="53" stroke="#fff" stroke-width="2"/>
                <line x1="20" y1="43" x2="20" y2="37" stroke="#fff" stroke-width="2.5"/>
                <line x1="24" y1="27" x2="33" y2="18" stroke="#fff" stroke-width="2"/>
                <!-- Inner circle for resonance -->
                <circle cx="40" cy="40" r="18" fill="none" stroke="#fff" stroke-width="1.5" opacity="0.5"/>
            </svg>`,
        'methane': `
            <svg viewBox="0 0 80 80" width="50" height="50">
                <defs>
                    <radialGradient id="methaneC">
                        <stop offset="0%" style="stop-color:#666666"/>
                        <stop offset="100%" style="stop-color:#333333"/>
                    </radialGradient>
                    <radialGradient id="methaneH">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#cccccc"/>
                    </radialGradient>
                </defs>
                <!-- Tetrahedral CH4 -->
                <circle cx="40" cy="40" r="11" fill="url(#methaneC)"/>
                <circle cx="40" cy="15" r="7" fill="url(#methaneH)"/>
                <circle cx="65" cy="50" r="7" fill="url(#methaneH)"/>
                <circle cx="15" cy="50" r="7" fill="url(#methaneH)"/>
                <circle cx="40" cy="65" r="7" fill="url(#methaneH)"/>
                <!-- Bonds -->
                <line x1="40" y1="29" x2="40" y2="22" stroke="#fff" stroke-width="2"/>
                <line x1="48" y1="46" x2="58" y2="50" stroke="#fff" stroke-width="2"/>
                <line x1="32" y1="46" x2="22" y2="50" stroke="#fff" stroke-width="2"/>
                <line x1="40" y1="51" x2="40" y2="58" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'ammonia': `
            <svg viewBox="0 0 80 60" width="50" height="40">
                <defs>
                    <radialGradient id="nitrogen">
                        <stop offset="0%" style="stop-color:#4444ff"/>
                        <stop offset="100%" style="stop-color:#0000cc"/>
                    </radialGradient>
                    <radialGradient id="ammoniaH">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#cccccc"/>
                    </radialGradient>
                </defs>
                <!-- Trigonal pyramidal NH3 -->
                <circle cx="40" cy="25" r="11" fill="url(#nitrogen)"/>
                <circle cx="20" cy="50" r="7" fill="url(#ammoniaH)"/>
                <circle cx="40" cy="55" r="7" fill="url(#ammoniaH)"/>
                <circle cx="60" cy="50" r="7" fill="url(#ammoniaH)"/>
                <!-- Bonds -->
                <line x1="32" y1="34" x2="24" y2="44" stroke="#fff" stroke-width="2"/>
                <line x1="40" y1="36" x2="40" y2="48" stroke="#fff" stroke-width="2"/>
                <line x1="48" y1="34" x2="56" y2="44" stroke="#fff" stroke-width="2"/>
            </svg>`,
        'default': `
            <svg viewBox="0 0 60 60" width="45" height="45">
                <defs>
                    <radialGradient id="defaultAtom">
                        <stop offset="0%" style="stop-color:#667eea"/>
                        <stop offset="100%" style="stop-color:#764ba2"/>
                    </radialGradient>
                </defs>
                <!-- Generic molecule/atom -->
                <circle cx="30" cy="30" r="15" fill="url(#defaultAtom)"/>
                <circle cx="30" cy="30" r="20" fill="none" stroke="#667eea" stroke-width="1.5" opacity="0.3"/>
                <circle cx="30" cy="30" r="25" fill="none" stroke="#667eea" stroke-width="1" opacity="0.2"/>
            </svg>`
    };
    
    const structure = moleculeStructures[moleculeName.toLowerCase()] || moleculeStructures['default'];
    
    bubble.innerHTML = `
        <div class="molecule-bubble-icon">${structure}</div>
        <div class="molecule-bubble-name">${moleculeName}</div>
    `;
    
    makeBubbleDraggable(bubble);
    
    bubble.addEventListener('click', (e) => {
        if (!bubble.classList.contains('dragging')) {
            openMoleculeModal(moleculeName);
        }
    });
    
    container.appendChild(bubble);
    activeBubbles.push(bubble);
    
    setTimeout(() => {
        bubble.style.opacity = '1';
    }, 100);
    
    console.log(` Created bubble for: ${moleculeName}`);
    
    setTimeout(() => {
        removeMoleculeBubble(bubble);
    }, 30000);
}

function makeBubbleDraggable(bubble) {
    let isDragging = false;
    let startX, startY, initialX, initialY;
    
    bubble.addEventListener('mousedown', startDrag);
    bubble.addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        bubble.classList.add('dragging');
        
        const touch = e.type === 'touchstart' ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        
        const rect = bubble.getBoundingClientRect();
        initialX = rect.left;
        initialY = rect.top;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        
        const touch = e.type === 'touchmove' ? e.touches[0] : e;
        const deltaX = touch.clientX - startX;
        const deltaY = touch.clientY - startY;
        
        bubble.style.left = (initialX + deltaX) + 'px';
        bubble.style.top = (initialY + deltaY) + 'px';
        bubble.style.right = 'auto';
    }
    
    function stopDrag() {
        setTimeout(() => {
            isDragging = false;
            bubble.classList.remove('dragging');
        }, 100);
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
    }
}

function removeMoleculeBubble(bubble) {
    bubble.style.opacity = '0';
    bubble.style.transform = 'scale(0)';
    setTimeout(() => {
        bubble.remove();
        activeBubbles = activeBubbles.filter(b => b !== bubble);
    }, 300);
}

// Enhanced molecule viewer with lone pairs
let currentMoleculeData = null;
let showingLonePairs = false;
let showingLabels = false;

async function openMoleculeModal(moleculeName) {
    const modal = document.getElementById('molecule-modal');
    const nameElement = document.getElementById('modal-molecule-name');
    const formulaElement = document.getElementById('modal-molecule-formula');
    const viewerElement = document.getElementById('modal-molecule-viewer');
    
    modal.classList.add('active');
    nameElement.textContent = moleculeName.charAt(0).toUpperCase() + moleculeName.slice(1);
    formulaElement.textContent = 'Loading molecular data...';
    
    viewerElement.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; gap: 16px;">
            <div style="font-size: 64px; animation: spin 2s linear infinite;"></div>
            <div style="color: #667eea; font-size: 18px; font-weight: 600;">Loading Molecule...</div>
        </div>
    `;
    
    if (!modalViewer) {
        modalViewer = $3Dmol.createViewer(viewerElement, {
            backgroundColor: '#0f0f1e'
        });
    }
    
    try {
        const response = await fetch(
            `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(moleculeName)}/SDF`
        );
        
        if (!response.ok) throw new Error('Molecule not found');
        
        const sdfData = await response.text();
        
        viewerElement.innerHTML = '';
        modalViewer = $3Dmol.createViewer(viewerElement, {
            backgroundColor: '#0f0f1e'
        });
        
        modalViewer.addModel(sdfData, 'sdf');
        
        // Store molecule data for lone pairs
        currentMoleculeData = modalViewer.getModel();
        
        // Calculate and display molecular properties
        updateMolecularProperties(currentMoleculeData, moleculeName);
        
        // Apply default style (ball-stick)
        currentModalStyle = 'ball-stick';
        applyModalStyle('ball-stick');
        
        // Reset toggles
        const lonePairToggle = document.getElementById('show-lone-pairs');
        const labelsToggle = document.getElementById('show-labels');
        if (lonePairToggle) lonePairToggle.checked = false;
        if (labelsToggle) labelsToggle.checked = false;
        showingLonePairs = false;
        showingLabels = false;
        
        modalViewer.zoomTo();
        modalViewer.render();
        
        console.log(` Loaded ${moleculeName} in enhanced modal`);
        
    } catch (error) {
        console.error('Failed to load molecule:', error);
        viewerElement.innerHTML = `
            <div style="color: #ff4757; padding: 60px 40px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 24px;"></div>
                <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">Could not load "${moleculeName}"</div>
                <div style="font-size: 14px; opacity: 0.7; line-height: 1.6;">
                    Try these molecules:<br>
                    water, ammonia, methane, ethanol, glucose, benzene
                </div>
            </div>
        `;
        formulaElement.textContent = 'Not available';
    }
}

function closeMoleculeModal() {
    const modal = document.getElementById('molecule-modal');
    modal.classList.remove('active');
}

function applyModalStyle(style) {
    if (!modalViewer) return;
    
    // Remove active class from all style buttons
    document.querySelectorAll('.style-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to selected button
    const activeBtn = document.getElementById(`style-${style}`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    modalViewer.setStyle({}, {});
    
    switch(style) {
        case 'stick':
            modalViewer.setStyle({}, {stick: {radius: 0.15, colorscheme: 'Jmol'}});
            break;
        case 'sphere':
            modalViewer.setStyle({}, {sphere: {scale: 0.35, colorscheme: 'Jmol'}});
            break;
        case 'ball-stick':
            modalViewer.setStyle({}, {
                stick: {radius: 0.15, colorscheme: 'Jmol'}, 
                sphere: {scale: 0.25, colorscheme: 'Jmol'}
            });
            break;
    }
    
    currentModalStyle = style;
    
    // Reapply lone pairs if they were showing
    if (showingLonePairs) {
        addLonePairs();
    }
    
    modalViewer.render();
    console.log(` Applied style: ${style}`);
}

function toggleLonePairs(show) {
    if (!modalViewer || !currentMoleculeData) return;
    
    showingLonePairs = show;
    
    if (show) {
        addLonePairs();
        console.log(' Showing lone pairs');
    } else {
        // Remove lone pairs by re-rendering without them
        applyModalStyle(currentModalStyle);
        console.log(' Hiding lone pairs');
    }
}

function addLonePairs() {
    if (!modalViewer || !currentMoleculeData) return;
    
    const atoms = currentMoleculeData.selectedAtoms({});
    
    // Add lone pairs for oxygen and nitrogen atoms
    atoms.forEach(atom => {
        const element = atom.elem;
        const pos = atom;
        
        // Oxygen typically has 2 lone pairs (4 dots total)
        if (element === 'O') {
            addLonePairLobes(pos, 2, 0.5); // 2 pairs
        }
        // Nitrogen typically has 1 lone pair (2 dots total)
        else if (element === 'N') {
            addLonePairLobes(pos, 1, 0.6); // 1 pair
        }
    });
    
    modalViewer.render();
}

function addLonePairLobes(atomPos, pairCount, distance) {
    // Add TWO small spheres per lone pair to represent electron pair
    
    const lonePairColor = '#FFD700'; // Golden color
    const dotSize = 0.12; // Smaller dots
    const dotSeparation = 0.15; // Distance between the 2 dots in a pair
    
    for (let i = 0; i < pairCount; i++) {
        // Calculate position for this lone pair around the atom
        const angle = (i * 2 * Math.PI) / pairCount + Math.PI / 4;
        
        // Base position for the lone pair
        const baseX = atomPos.x + distance * Math.cos(angle);
        const baseY = atomPos.y + distance * Math.sin(angle);
        const baseZ = atomPos.z + distance * 0.3;
        
        // Create TWO dots for each lone pair (electron pair = 2 electrons)
        // Dot 1 (slightly to the left)
        modalViewer.addSphere({
            center: {
                x: baseX - dotSeparation * Math.sin(angle) * 0.5,
                y: baseY + dotSeparation * Math.cos(angle) * 0.5,
                z: baseZ
            },
            radius: dotSize,
            color: lonePairColor,
            alpha: 0.8
        });
        
        // Dot 2 (slightly to the right)
        modalViewer.addSphere({
            center: {
                x: baseX + dotSeparation * Math.sin(angle) * 0.5,
                y: baseY - dotSeparation * Math.cos(angle) * 0.5,
                z: baseZ
            },
            radius: dotSize,
            color: lonePairColor,
            alpha: 0.8
        });
    }
}

function toggleLabels(show) {
    if (!modalViewer) return;
    
    showingLabels = show;
    
    if (show) {
        const atoms = modalViewer.getModel().selectedAtoms({});
        atoms.forEach((atom, index) => {
            modalViewer.addLabel(atom.elem + (index + 1), {
                position: atom,
                fontSize: 12,
                fontColor: 'white',
                backgroundColor: 'rgba(0,0,0,0.7)',
                backgroundOpacity: 0.7
            });
        });
        console.log(' Showing atom labels');
    } else {
        modalViewer.removeAllLabels();
        console.log(' Hiding atom labels');
    }
    
    modalViewer.render();
}

function updateMolecularProperties(model, moleculeName) {
    try {
        const atoms = model.selectedAtoms({});
        
        // Count atoms by element
        const elementCounts = {};
        atoms.forEach(atom => {
            const elem = atom.elem;
            elementCounts[elem] = (elementCounts[elem] || 0) + 1;
        });
        
        // Build formula string
        let formula = '';
        const elementOrder = ['C', 'H', 'O', 'N', 'S', 'P', 'Cl', 'Br', 'F', 'I'];
        elementOrder.forEach(elem => {
            if (elementCounts[elem]) {
                formula += elem;
                if (elementCounts[elem] > 1) {
                    formula += elementCounts[elem];
                }
            }
        });
        
        // Add remaining elements
        Object.keys(elementCounts).forEach(elem => {
            if (!elementOrder.includes(elem)) {
                formula += elem;
                if (elementCounts[elem] > 1) {
                    formula += elementCounts[elem];
                }
            }
        });
        
        // Calculate molecular weight (simplified)
        const atomicWeights = {
            'H': 1.008, 'C': 12.011, 'N': 14.007, 'O': 15.999,
            'S': 32.06, 'P': 30.974, 'Cl': 35.45, 'Br': 79.904,
            'F': 18.998, 'I': 126.90
        };
        
        let molecularWeight = 0;
        Object.keys(elementCounts).forEach(elem => {
            if (atomicWeights[elem]) {
                molecularWeight += atomicWeights[elem] * elementCounts[elem];
            }
        });
        
        // Count bonds
        let bondCount = 0;
        try {
            const bonds = model.selectedBonds({});
            bondCount = bonds ? bonds.length : 0;
        } catch (e) {
            console.log('Could not count bonds:', e);
        }
        
        // Update DOM
        const formulaElem = document.getElementById('modal-molecule-formula');
        const propFormula = document.getElementById('prop-formula');
        const propWeight = document.getElementById('prop-weight');
        const propAtoms = document.getElementById('prop-atoms');
        const propBonds = document.getElementById('prop-bonds');
        
        if (formulaElem) formulaElem.textContent = formula || 'Unknown';
        if (propFormula) propFormula.textContent = formula || '-';
        if (propWeight) propWeight.textContent = molecularWeight > 0 ? molecularWeight.toFixed(2) + ' g/mol' : '-';
        if (propAtoms) propAtoms.textContent = atoms.length || '-';
        if (propBonds) propBonds.textContent = bondCount || '-';
        
        console.log(` Properties: ${formula}, ${molecularWeight.toFixed(2)} g/mol, ${atoms.length} atoms`);
        
    } catch (error) {
        console.error('Error calculating properties:', error);
    }
}

function resetModalView() {
    if (!modalViewer) return;
    modalViewer.zoomTo();
    modalViewer.rotate(0, {x:0, y:1, z:0});
    modalViewer.render();
    console.log(' View reset');
}


function downloadModalMolecule() {
    const moleculeName = document.getElementById('modal-molecule-name').textContent.replace(' ', '');
    const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(moleculeName)}/SDF`;
    window.open(url, '_blank');
}

// COMPLEXITY SLIDER
let currentComplexity = 5;

function updateComplexityCompact(value) {
  currentComplexity = parseInt(value);
  document.getElementById('complexity-value-compact').textContent = value;
  localStorage.setItem('eightysix_complexity', currentComplexity);
  console.log(` Complexity: ${currentComplexity}/10`);
}

window.addEventListener('load', () => {
  const savedComplexity = localStorage.getItem('eightysix_complexity');
  if (savedComplexity) {
    const slider = document.getElementById('complexity-slider-compact');
    if (slider) {
      slider.value = savedComplexity;
      updateComplexityCompact(savedComplexity);
    }
  }
  
  // Start study session if not already started (only if tab is visible)
  const progress = getProgressData();
  if (!document.hidden) {
    if (!progress.sessionStartTime) {
      console.log(' No active session, starting study timer on page load');
      startStudySession();
    } else {
      console.log(' Study session already active since:', new Date(progress.sessionStartTime).toLocaleTimeString());
    }
    console.log(' Tab is visible - time tracking active');
  } else {
    console.log(' Tab is hidden - time tracking paused');
  }
});

// ==========================================
// ACTIVE TIME TRACKING (Only when tab is visible)
// ==========================================

let isTabActive = !document.hidden;
let lastActiveTime = Date.now();

// Track when tab visibility changes
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // Tab became inactive (user switched tabs or minimized window)
    console.log(' Tab inactive - pausing time tracking');
    isTabActive = false;
    
    // Save the time accumulated while tab was active
    updateStudyTime();
  } else {
    // Tab became active again
    console.log(' Tab active - resuming time tracking');
    isTabActive = true;
    lastActiveTime = Date.now();
    
    // Restart session timer
    const progress = getProgressData();
    progress.sessionStartTime = Date.now();
    saveProgressData(progress);
  }
});

// Update study time every 1 minute (only if tab is active)
setInterval(() => {
  if (isTabActive && !document.hidden) {
    updateStudyTime();
    console.log(' Study time updated (1 minute interval) - Tab is active');
  } else {
    console.log(' Skipping time update - Tab is inactive');
  }
}, 60000); // 1 minute

async function handlePPTUpload(event) {
  const file = event.target.files[0];
  
  if (!file) return;
  
  console.log(` Uploading: ${file.name}`);
  
  // Show loading
  showLoadingModal('Processing PowerPoint...', 'This may take 30-60 seconds');
  
  try {
    // Upload and extract
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('http://localhost:5000/upload-ppt', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      console.log(` Extracted ${data.total_slides} slides`);
      
      // Store slides data
      window.currentSlides = data.slides;
      
      // Hide loading, show options
      hideLoadingModal();
      showMaterialGeneratorModal(data);
      
    } else {
      throw new Error(data.error);
    }
    
  } catch (error) {
    console.error(' Error:', error);
    hideLoadingModal();
    alert('Error processing PowerPoint: ' + error.message);
  }
}

function showMaterialGeneratorModal(data) {
  const modal = document.createElement('div');
  modal.id = 'material-generator-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="
      background: #1a1a1a;
      padding: 32px;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    ">
      <h2 style="color: white; margin-bottom: 8px;">
         Generate Study Materials
      </h2>
      <p style="color: #aaa; margin-bottom: 24px;">
        From: ${data.filename} (${data.total_slides} slides)
      </p>
      
      <div style="display: grid; gap: 12px;">
        <button onclick="generateMaterial('notes')" class="material-btn">
           Study Notes
          <span style="font-size: 12px; color: #aaa; display: block;">
            Comprehensive notes with key concepts
          </span>
        </button>
        
        <button onclick="generateMaterial('reviewer')" class="material-btn">
           Exam Reviewer
          <span style="font-size: 12px; color: #aaa; display: block;">
            Must-know concepts + practice problems
          </span>
        </button>
        
        <button onclick="generateMaterial('flashcards')" class="material-btn">
           Flashcards
          <span style="font-size: 12px; color: #aaa; display: block;">
            15-20 cards for memorization
          </span>
        </button>
        
        <button onclick="generateMaterial('summary')" class="material-btn">
           Summary Sheet
          <span style="font-size: 12px; color: #aaa; display: block;">
            One-page cheat sheet
          </span>
        </button>
        
        <button onclick="generateMaterial('quiz')" class="material-btn">
           Practice Quiz
          <span style="font-size: 12px; color: #aaa; display: block;">
            10 multiple choice questions
          </span>
        </button>
        
        <button onclick="generateMaterial('all')" class="material-btn" style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          margin-top: 12px;
        ">
           Generate Everything
          <span style="font-size: 12px; color: white; display: block;">
            All study materials at once
          </span>
        </button>
      </div>
      
      <button onclick="closeMaterialGenerator()" style="
        width: 100%;
        margin-top: 16px;
        padding: 12px;
        background: transparent;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        color: #aaa;
        cursor: pointer;
      ">
        Cancel
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function generateMaterial(type) {
  console.log(` Generating ${type}...`);
  
  closeMaterialGenerator();
  showLoadingModal(`Generating ${type}...`, 'AI is creating your study materials');
  
  try {
    const response = await fetch('http://localhost:5000/generate-study-materials', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        slides: window.currentSlides,
        type: type
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      hideLoadingModal();
      displayGeneratedMaterials(data.materials, type);
    } else {
      throw new Error(data.error);
    }
    
  } catch (error) {
    console.error(' Error:', error);
    hideLoadingModal();
    alert('Error generating materials: ' + error.message);
  }
}

function displayGeneratedMaterials(materials, type) {
  const modal = document.createElement('div');
  modal.id = 'materials-display-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  let content = '';
  
  // Build tabs
  let tabs = '';
  let tabContent = '';
  
  for (const [key, value] of Object.entries(materials)) {
    tabs += `
      <button onclick="switchMaterialTab('${key}')" 
        id="tab-${key}"
        style="
          padding: 12px 24px;
          background: rgba(102, 126, 234, 0.2);
          border: none;
          border-radius: 8px 8px 0 0;
          color: white;
          cursor: pointer;
          font-weight: 600;
        ">
        ${key.toUpperCase()}
      </button>
    `;
    
    tabContent += `
      <div id="content-${key}" class="material-content" style="display: none;">
        <div style="white-space: pre-wrap; line-height: 1.8;">
          ${formatMaterialContent(value, key)}
        </div>
      </div>
    `;
  }
  
  modal.innerHTML = `
    <div style="
      background: #1a1a1a;
      padding: 0;
      border-radius: 16px;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    ">
      <div style="padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h2 style="color: white; margin: 0;">
           Generated Study Materials
        </h2>
      </div>
      
      <div style="display: flex; gap: 8px; padding: 16px; background: rgba(0,0,0,0.3);">
        ${tabs}
      </div>
      
      <div style="flex: 1; overflow-y: auto; padding: 24px; color: white;">
        ${tabContent}
      </div>
      
      <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 12px;">
        <button onclick="downloadMaterials()" style="
          flex: 1;
          padding: 12px;
          background: #667eea;
          border: none;
          border-radius: 8px;
          color: white;
          font-weight: 600;
          cursor: pointer;
        ">
           Download PDF
        </button>
        <button onclick="closeMaterialsDisplay()" style="
          flex: 1;
          padding: 12px;
          background: transparent;
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 8px;
          color: white;
          cursor: pointer;
        ">
          Close
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Show first tab
  const firstKey = Object.keys(materials)[0];
  switchMaterialTab(firstKey);
}

function formatMaterialContent(content, type) {
  // Convert markdown-style formatting to HTML
  let formatted = content
    .replace(/### (.*)/g, '<h3 style="color: #667eea; margin-top: 24px;">$1</h3>')
    .replace(/## (.*)/g, '<h2 style="color: #667eea; margin-top: 32px;">$1</h2>')
    .replace(/# (.*)/g, '<h1 style="color: #667eea; margin-top: 40px;">$1</h1>')
    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #fff;">$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/^- (.*)/gm, '<li>$1</li>')
    .replace(/(\n\n)/g, '<br><br>');
  
  return formatted;
}

function switchMaterialTab(tabKey) {
  // Hide all content
  document.querySelectorAll('.material-content').forEach(el => {
    el.style.display = 'none';
  });
  
  // Reset all tabs
  document.querySelectorAll('[id^="tab-"]').forEach(el => {
    el.style.background = 'rgba(255,255,255,0.05)';
  });
  
  // Show selected
  document.getElementById(`content-${tabKey}`).style.display = 'block';
  document.getElementById(`tab-${tabKey}`).style.background = 'rgba(102, 126, 234, 0.3)';
}

// Helper functions
function closeMaterialGenerator() {
  const modal = document.getElementById('material-generator-modal');
  if (modal) modal.remove();
}

function closeMaterialsDisplay() {
  const modal = document.getElementById('materials-display-modal');
  if (modal) modal.remove();
}

function showLoadingModal(title, message) {
  const modal = document.createElement('div');
  modal.id = 'loading-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
  `;
  
  modal.innerHTML = `
    <div style="
      background: #1a1a1a;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      max-width: 400px;
    ">
      <div style="
        width: 60px;
        height: 60px;
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        margin: 0 auto 24px;
        animation: spin 1s linear infinite;
      "></div>
      <h3 style="color: white; margin-bottom: 8px;">${title}</h3>
      <p style="color: #aaa;">${message}</p>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function hideLoadingModal() {
  const modal = document.getElementById('loading-modal');
  if (modal) modal.remove();
}
// ==========================================
// 30-MINUTE HEALTH REMINDER SYSTEM
// ==========================================

try {
  let healthReminderTime = 0; // Minutes of active study time
  let healthReminderInterval = 30; // Show reminder every 30 minutes

  const healthReminders = [
    {
      icon: '',
      title: 'Stay Hydrated!',
      message: 'Time for a water break!',
      tips: [
        { icon: '', text: 'Drink a glass of water' },
        { icon: '', text: 'Stay hydrated for better focus' },
        { icon: '', text: 'Water helps brain function' }
      ]
    },
    {
      icon: '',
      title: 'Time to Stretch!',
      message: 'Your body needs a break!',
      tips: [
        { icon: '', text: 'Stretch your arms and neck' },
        { icon: '', text: 'Stand up and stretch legs' },
        { icon: '', text: 'Roll your shoulders' }
      ]
    },
    {
      icon: '',
      title: 'Rest Your Eyes!',
      message: 'Give your eyes a break!',
      tips: [
        { icon: '', text: 'Look away from screen' },
        { icon: '', text: 'Look at something 20 feet away' },
        { icon: '', text: 'Blink and relax your eyes' }
      ]
    },
    {
      icon: '',
      title: 'Take a Walk!',
      message: 'Move your body!',
      tips: [
        { icon: '', text: 'Walk around for 5 minutes' },
        { icon: '', text: 'Light movement boosts focus' },
        { icon: '', text: 'Get some fresh air' }
      ]
    },
    {
      icon: '',
      title: 'Brain Break!',
      message: 'Give your mind a rest!',
      tips: [
        { icon: '', text: 'Close your eyes for 2 minutes' },
        { icon: '', text: 'Listen to calm music' },
        { icon: '', text: 'Practice deep breathing' }
      ]
    },
    {
      icon: '',
      title: 'Snack Time!',
      message: 'Fuel your brain!',
      tips: [
        { icon: '', text: 'Have a healthy snack' },
        { icon: '', text: 'Nuts boost brain power' },
        { icon: '', text: 'Fruit gives quick energy' }
      ]
    }
  ];

  let lastReminderIndex = -1;

  function getRandomReminder() {
    let index;
    do {
      index = Math.floor(Math.random() * healthReminders.length);
    } while (index === lastReminderIndex && healthReminders.length > 1);
    lastReminderIndex = index;
    return healthReminders[index];
  }

  function showHealthReminder() {
    const reminder = getRandomReminder();
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'health-reminder-overlay';
    overlay.id = 'health-reminder-overlay';
    
    // Build tips HTML
    let tipsHTML = '';
    reminder.tips.forEach(tip => {
      tipsHTML += `
        <div class="health-tip-item">
          <span class="health-tip-icon">${tip.icon}</span>
          <span>${tip.text}</span>
        </div>
      `;
    });
    
    overlay.innerHTML = `
      <div class="health-reminder-modal">
        <div class="health-reminder-icon">${reminder.icon}</div>
        <div class="health-reminder-title">${reminder.title}</div>
        <div class="health-reminder-message">${reminder.message}</div>
        <div class="health-reminder-time">You've been studying for ${healthReminderTime} minutes! </div>
        
        <div class="health-reminder-tips">
          <div class="health-reminder-tips-title">Quick Health Tips</div>
          ${tipsHTML}
        </div>
        
        <button class="health-reminder-button" onclick="dismissHealthReminder()">
          Got it! Back to studying 
        </button>
      </div>
    `;
    
    document.body.appendChild(overlay);
    console.log(` Health reminder shown after ${healthReminderTime} minutes`);
  }

  window.dismissHealthReminder = function() {
    const overlay = document.getElementById('health-reminder-overlay');
    if (overlay) {
      overlay.style.animation = 'fadeOut 0.3s ease-out';
      setTimeout(() => {
        overlay.remove();
        console.log(' Health reminder dismissed');
      }, 300);
    }
    
    // Reset timer
    healthReminderTime = 0;
  };

  // Add fadeOut animation
  const styleElement = document.createElement('style');
  styleElement.textContent = `
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  document.head.appendChild(styleElement);

  // Check for health reminder every minute (when tab is active)
  setInterval(() => {
    if (typeof isTabActive !== 'undefined' && isTabActive && !document.hidden) {
      healthReminderTime++;
      
      // Show reminder every 30 minutes
      if (healthReminderTime >= healthReminderInterval && healthReminderTime % healthReminderInterval === 0) {
        showHealthReminder();
      }
    }
  }, 60000); // 1 minute

  console.log(' Health reminder system initialized');
} catch (error) {
  console.error(' Health reminder initialization error:', error);
  // Health reminders disabled, but chat will still work
}

// CHUNKS SIDEBAR TAB SWITCHING
let currentChunksTab = 'chats';

function switchChunksTab(tabName) {
  currentChunksTab = tabName;
  
  document.querySelectorAll('.chunks-tab-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-tab') === tabName) {
      btn.classList.add('active');
    }
  });
  
  document.querySelectorAll('.chunks-tab-panel').forEach(panel => {
    panel.classList.remove('active');
  });
  document.getElementById(`panel-${tabName}`).classList.add('active');
  
  if (tabName === 'chats') {
    displayChatHistory();
  } else if (tabName === 'contents') {
    renderChunksContents();
  } else if (tabName === 'books') {
    renderChunksBooks();
  } else if (tabName === 'progress') {
    renderSidebarProgress();
  }
  
  console.log(` Switched to ${tabName} tab`);
}

function renderChunksContents() {
  const contentList = document.getElementById('chunks-content-list');
  
  if (!pdfDoc || outlineData.length === 0) {
    contentList.innerHTML = `
      <div class="chat-history-empty">
        <div class="chunks-empty-icon"><svg class="icon" width="18" height="18"><use href="#icon-document"/></svg></div>
        <div class="chunks-empty-text">Select a book to see contents</div>
      </div>
    `;
    return;
  }
  
  contentList.innerHTML = outlineData.map(item => `
    <div class="chunks-content-item" onclick="jumpToPage(${item.page}); if(window.innerWidth < 768) toggleChatHistory();">
      <div class="chunks-content-title">${escapeHtml(item.title)}</div>
      <div class="chunks-content-page">Page ${item.page}</div>
    </div>
  `).join('');
}

function renderChunksBooks() {
  const booksList = document.getElementById('chunks-books-list');
  
  if (!pdfDoc) {
    booksList.innerHTML = `
      <div class="chat-history-empty">
        <div class="chunks-empty-icon"><svg class="icon" width="18" height="18"><use href="#icon-books"/></svg></div>
        <div class="chunks-empty-text">Select a book from the library</div>
        <button class="chunks-upload-btn" onclick="openLibraryModal()">
          Browse Library
        </button>
      </div>
    `;
    return;
  }
  
  booksList.innerHTML = `
    <div class="chunks-book-card active">
      <div class="chunks-book-cover"><svg class="icon" width="18" height="18"><use href="#icon-document"/></svg></div>
      <div class="chunks-book-info">
        <div class="chunks-book-title">Chemistry Textbook</div>
        <div class="chunks-book-pages">${pdfDoc.numPages} pages</div>
      </div>
    </div>
  `;
}

function filterChatHistory() {
  const searchQuery = document.getElementById('chunks-search-input').value;
  const items = document.querySelectorAll('.chat-history-item');
  items.forEach(item => {
    const title = item.querySelector('.chat-history-title').textContent.toLowerCase();
    const preview = item.querySelector('.chat-history-preview')?.textContent.toLowerCase() || '';
    const matches = title.includes(searchQuery.toLowerCase()) || preview.includes(searchQuery.toLowerCase());
    item.style.display = matches ? 'block' : 'none';
  });
}

console.log(' Chunks initialized - Beautiful UI ready!');

// Initialize Lucide icons
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
    console.log(' Lucide icons initialized');
    
    // Re-initialize Lucide icons when molecule modal opens
    const originalOpenModal = openMoleculeModal;
    openMoleculeModal = async function(moleculeName) {
        await originalOpenModal(moleculeName);
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
    };
}
  
function highlightSentence(sentence) {
  if (!sentence) return;

  const layers = document.querySelectorAll(".textLayer");

  layers.forEach(layer => {
    if (layer.innerText.includes(sentence)) {
      const regex = new RegExp(sentence, "gi");
      layer.innerHTML = layer.innerHTML.replace(
        regex,
        `<span style="background: yellow; padding:2px;">${sentence}</span>`
      );
    }
  });
}
</script>

</body>
</html>
